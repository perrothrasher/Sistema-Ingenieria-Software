<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dotación de Personal - Área de Prendas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .form-container {
      background-color: #f4f4f4;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 20px auto;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 0.3rem;
    }

    input, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      background-color: #007bff;
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border: 1px solid #ccc;
    }

    th {
      background-color: #5a67d8;
      color: white;
    }

    td {
      background-color: #f9f9f9;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .action-buttons button {
      background-color: #4a5568;
      padding: 6px 12px;
      font-size: 0.9rem;
      border: none;
      color: white;
      border-radius: 4px;
    }

    .action-buttons button:hover {
      background-color: #2d3748;
    }

    @media (max-width: 600px) {
      table {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="top-bar d-flex align-items-center">
    <div class="container-fluid">
      <nav class="navbar navbar-expand-lg w-100">
        <a class="navbar-brand" href="#">
    <img src="assets/totalcheck-logo.png" alt="TotalCheck Logo" style="height:30px; width:auto;">
        </a>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="index.html">
                <i class="fas fa-home"></i> Inicio
              </a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                <i class="fas fa-edit"></i> Editar
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" id="dropdownEditarCliente" href="editar_cliente.html"><i class="fas fa-user-edit"></i> Editar Clientes</a></li>
                <li><a class="dropdown-item" href="ver_cliente.html"><i class="fas fa-users"></i> Ver Clientes</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" id="dropdownEditarTrabajador" href="editar_trabajador.html"><i class="fas fa-user-tie"></i> Editar Trabajador</a></li>
                <li><a class="dropdown-item" href="ver_trabajador.html"><i class="fas fa-users-cog"></i> Ver Trabajadores</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                <i class="fas fa-plus"></i> Agregar
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" id="dropdownRegistrarCliente" href="registro_cliente.html"><i class="fas fa-user-plus"></i> Agregar Clientes</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" id="dropdownRegistrar" href="registro2.html"><i class="fas fa-user-plus"></i> Agregar Trabajador</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                <i class="fas fa-chart-line"></i> Dotación
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="dotacion_personal.html"><i class="fas fa-users"></i> Agregar Dotación</a></li>
                <li><a class="dropdown-item" href="carga_datos_historicos.html"><i class="fas fa-upload"></i> Cargar Datos</a></li>
                <li><a class="dropdown-item" href="visualizar_datos_historicos.html"><i class="fas fa-chart-bar"></i> Visualizar Datos</a></li>
                <li><a class="dropdown-item" href="predicción.html"><i class="fas fa-crystal-ball"></i> Ver Predicción</a></li>
              </ul>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                <i class="fas fa-user-circle"></i> <span id="welcomeMessage">Usuario</span>
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
    </div>
  </div>

  <div class="container">
    <h1><i class="fas fa-users-cog"></i> Gestión de Dotación de Personal</h1>
    <form id="dotacionForm">
      <!-- Seleccion de Mes y Año-->
      <label for="mes">Mes:</label>
      <select id="mes" name="mes" required>
        <option value="" disabled selected>Seleccione un mes</option>
        <option value="1">Enero</option>
        <option value="2">Febrero</option>
        <option value="3">Marzo</option>
        <option value="4">Abril</option>
        <option value="5">Mayo</option>
        <option value="6">Junio</option>
        <option value="7">Julio</option>
        <option value="8">Agosto</option>
        <option value="9">Septiembre</option>
        <option value="10">Octubre</option>
        <option value="11">Noviembre</option>
        <option value="12">Diciembre</option>
      </select>

      <label for="anio">Año:</label>
      <select id="anio" name="anio" required>
        <option value="" disabled selected>Seleccione un año</option>
        <option value="2025">2025</option>
        <option value="2024">2024</option>
        <option value="2023">2023</option>
        <option value="2022">2022</option>
        <option value="2021">2021</option>
        <option value="2020">2020</option>
        <option value="2019">2019</option>
        <option value="2018">2018</option>
        <option value="2017">2017</option>
        <option value="2016">2016</option>
        <option value="2015">2015</option>
        <option value="2014">2014</option>
        <option value="2013">2013</option>
        <option value="2012">2012</option>
        <option value="2011">2011</option>
        <option value="2010">2010</option>
      </select>
      <!-- Seleccion del tipo de contrato-->
      <label for="tipo_contrato">Tipo de Contrato:</label>
        <select id="tipo_contrato" name="tipo_contrato" required>
          <option value="" disabled selected>Seleccione un tipo de contrato</option>
          <option value="1">Full Time</option>
          <option value="2">Part Time</option>
        </select>
      
      <!--- Cantidad de personal--->
      <label for="cantidad_personal">Cantidad de Personal:</label>
      <input type="number" id="cantidad_personal" name="cantidad_personal" placeholder="Cantidad de personal" required min="1">

      <!-- Carga horaria-->
       <label for="carga_horaria">Carga Horaria:</label>
       <input type="number" id="carga_horaria" name="carga_horaria" placeholder="Carga horaria Mensual" required>

      <button type="submit">Actualizar Dotación</button>
    </form>
  </div>

  <script>
    function isDev(){
      try { return location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1'; }
      catch(_) { return true; }
    }

    window.addEventListener('load', async () =>{
            try{
                // se obtienen los datos del usuario desde el servidor
                const response = await fetch('/api/perfil');

                if (!response.ok){
                    if (isDev()) {
                      console.warn('Dev mode: perfil no disponible, se omite redirección al login');
                    } else {
                      window.location.href = 'login.html';
                      return;
                    }
                } else {
                    const usuario = await response.json();
                    if (usuario.nombre && usuario.apellido){
                        document.getElementById('welcomeMessage').innerText = `${usuario.nombre} ${usuario.apellido}`;
                    }
                    verificarAdmin(usuario.rol);
                }
            } catch (error){
                console.error('Error de autenticación: ', error);
                if (!isDev()) window.location.href = 'login.html';
            }
        });

        // PERMISOS
        function verificarAdmin(rol){
            console.log("Rol del usuario: ", rol);

            const dropdowns = {
                registrar: document.getElementById('dropdownRegistrar'),
                editarTrabajador: document.getElementById('dropdownEditarTrabajador'),
                editarCliente: document.getElementById('dropdownEditarCliente'),
                registrarCliente: document.getElementById('dropdownRegistrarCliente')
            };

            Object.values(dropdowns).forEach(dropdown => {
                dropdown.style.display = 'block';
            });

            if (rol === 'Soporte TI' || rol === 'Gerente'){
                Object.values(dropdowns).forEach(dropdown =>{
                    dropdown.style.pointerEvents = 'auto';
                    dropdown.style.color = '';
                    dropdown.style.textDecoration= '';
                });
            } else if(rol === 'Supervisor'){
                Object.values(dropdowns).forEach(dropdown =>{
                    dropdown.style.pointerEvents = 'none';
                    dropdown.style.color = 'Gray';
                    dropdown.style.textDecoration= 'none';
                });
            }
        }

        async function logout() {
            try { await fetch('/logout', { method: 'POST', credentials: 'include' }); } catch (e) {}
            try { sessionStorage.clear(); localStorage.clear(); } catch (e) {}
            try {
                document.cookie.split(';').forEach(c => {
                    const eqPos = c.indexOf('=');
                    const name = (eqPos > -1 ? c.substring(0, eqPos) : c).trim();
                    if (name) document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
                });
            } catch (e) {}
            window.location.replace('login.html');
        }

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');

    async function cargarDotacion(){
        try{
            const response = await fetch(`${URL_BASE}/get-dotaciones-edicion?id=${id}`);
            const data = await response.json();

            if (data.dotaciones && data.dotaciones.length > 0){
                const dotacion = data.dotaciones.find(dotacion => dotacion.id === parseInt(id));

                // Rellenar el formulario con los datos de la dotación
                const mesSelect = document.getElementById('mes');
                mesSelect.value = dotacion.mes_id || '';

                document.getElementById('anio').value = dotacion.anio || '';

                const contratoSelect = document.getElementById('tipo_contrato');
                contratoSelect.value = dotacion.TipoContrato_id || '';
                document.getElementById('cantidad_personal').value = dotacion.cantidad_personal || '';
                document.getElementById('carga_horaria').value = dotacion.carga_horaria || '';
            } else {
                alert('Dotación no encontrada');
            }
        } catch (error) {
            console.error('Error al obtener los datos de la dotación:', error);
            alert('Error al cargar los datos de la dotación.');
        }
    }
    cargarDotacion(id);

    document.getElementById('dotacionForm').addEventListener('submit', async function(e){
        e.preventDefault();

        // Obtener los valores del formulario
        const id = new URLSearchParams(window.location.search).get('id'); 
        const mes = document.getElementById('mes').value;
        const anio = document.getElementById('anio').value;
        const tipoContrato = document.getElementById('tipo_contrato').value;
        const cantidadPersonal = document.getElementById('cantidad_personal').value;
        const cargaHoraria = document.getElementById('carga_horaria').value;

        const updatedDotacion = {
            mes_id: mes,
            anio,
            TipoContrato_id: tipoContrato,  
            cantidad_personal: cantidadPersonal,
            carga_horaria: cargaHoraria
        };

        console.log('Datos enviados para actualizar la dotación:', updatedDotacion);

        try{
            const response = await fetch(`${URL_BASE}/editarDotacion/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedDotacion)
            });

            const result = await response.json();
            if (response.ok) {
                alert('Dotación actualizada con éxito');
                window.location.href = 'dotacion_personal.html';
            } else {
                throw new Error(result.message || 'Error al actualizar la dotación');
            }
        } catch (error){
            console.error('Error al actualizar la dotación:', error);
            alert('Hubo un error al actualizar la dotación.');
        }
    });
  </script>
</body>
</html>
