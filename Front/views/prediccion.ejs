<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Predicción de Dotación de Personal - Sistema</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="config_server.js"></script>

  <!-- === AÑADIDO: librerías para gráfico y exportaciones === -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* === estilos de tu maqueta, sin cambios en los cards === */
    .top-bar{background:#fff;height:60px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .navbar-brand{font-size:24px;font-weight:bold;color:#007bff!important;text-decoration:none}
    .navbar{background:#fff;padding:.2rem 1rem}
    .navbar-nav .nav-link{color:#6c757d;font-weight:500}
    .navbar-nav .nav-link:hover{color:#007bff}
    .dropdown-menu{border:none;box-shadow:0 4px 6px rgba(0,0,0,.1)}

    .metric-card{background:linear-gradient(135deg,#667eea,#764ba2);border-radius:15px;color:#fff;transition:transform .3s}
    .metric-card:hover{transform:translateY(-5px)}
    .metric-card.success{background:linear-gradient(135deg,#11998e,#38ef7d)}
    .metric-card.warning{background:linear-gradient(135deg,#f093fb,#f5576c)}
    .metric-card.info{background:linear-gradient(135deg,#4facfe,#00f2fe)}

    .chart-container{background:#fff;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1);padding:20px;margin-bottom:30px}
    .prediction-area{border:2px solid #e2e8f0;transition:all .3s;background:linear-gradient(135deg,#fff,#f8fafc);border-radius:15px;padding:24px}
    .prediction-area.processing{border-color:#4f46e5;background:linear-gradient(135deg,#eff6ff,#dbeafe)}
    .progress-bar{transition:width .3s;background:linear-gradient(90deg,#4f46e5,#7c3aed)}
    .fade-in{animation:fadeIn .5s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    body{overflow-x:hidden;background:linear-gradient(135deg,#f5f7fa,#c3cfe2)}
    .result-card{background:linear-gradient(135deg,#667eea,#764ba2);border-radius:15px;color:#fff;padding:20px;margin-bottom:20px}
    .estado-badge{font-size:14px}
  </style>
</head>
<body>
    <%- include('partials/navbar') %>

  <div class="container-fluid mt-4">
    <!-- Encabezado -->
    <div class="row mb-4">
      <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h2 mb-1"><i class="fas fa-crystal-ball text-primary"></i> Predicción de Dotación de Personal</h1>
          <p class="text-muted mb-0">Genera predicciones basadas en los Excel mensuales almacenados en MongoDB</p>
        </div>
        <div>
          <button class="btn btn-outline-primary me-2" onclick="refreshPredictions()"><i class="fas fa-sync-alt"></i> Actualizar</button>
          <button class="btn btn-primary" onclick="generatePrediction()"><i class="fas fa-magic"></i> Nueva Predicción</button>
        </div>
      </div>
    </div>

    <!-- === MÉTRICAS === -->
    <div class="row mb-4" id="metricsCards">
      <div class="col-xl-3 col-md-6 mb-4">
        <div class="metric-card p-4 h-100">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-white-50 small">Predicciones Generadas</div>
              <div class="h4 mb-0 text-white" id="totalPredictions">0</div>
            </div>
            <div class="align-self-center"><i class="fas fa-chart-line fa-2x text-white-50"></i></div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-4">
        <div class="metric-card success p-4 h-100">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-white-50 small">Precisión Promedio</div>
              <div class="h4 mb-0 text-white" id="avgAccuracy">95.2%</div>
            </div>
            <div class="align-self-center"><i class="fas fa-bullseye fa-2x text-white-50"></i></div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-4">
        <div class="metric-card warning p-4 h-100">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-white-50 small">Última Predicción</div>
              <div class="h6 mb-0 text-white" id="lastPrediction">Sin predicciones</div>
            </div>
            <div class="align-self-center"><i class="fas fa-clock fa-2x text-white-50"></i></div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-4">
        <div class="metric-card info p-4 h-100">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-white-50 small">Modelo IA</div>
              <div class="h6 mb-0 text-white" id="modeloIAEstado">Activo</div>
            </div>
            <div class="align-self-center"><i class="fas fa-robot fa-2x text-white-50"></i></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Parámetros -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="chart-container">
          <h5 class="mb-3"><i class="fas fa-sliders-h text-primary"></i> Parámetros de Predicción</h5>
          <div class="row g-3 align-items-end prediction-area" id="predictionArea">
            <div class="col-sm-4">
              <label class="form-label">Año (opcional)</label>
              <input id="anioInput" type="number" class="form-control" placeholder="Ej: 2025">
            </div>
            <div class="col-sm-4">
              <label class="form-label">Mes (1–12, opcional)</label>
              <input id="mesInput" type="number" class="form-control" placeholder="Ej: 8">
            </div>
            <div class="col-sm-4">
              <button class="btn btn-primary w-100" onclick="generatePrediction()"><i class="fas fa-magic"></i> Proyectar</button>
            </div>
            <div class="col-12">
              <button class="btn btn-outline-secondary" onclick="entrenarModelo()"><i class="fas fa-database"></i> Entrenar desde MongoDB</button>
              <small class="text-muted ms-2">Construye la base desde Excel en GridFS y deja lista la proyección.</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Progreso -->
    <div id="progressSection" class="row mb-4 d-none">
      <div class="col-12">
        <div class="chart-container">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="fw-bold text-dark">Procesando predicción...</span>
            <span id="progressText" class="text-primary fw-bold">0%</span>
          </div>
          <div class="progress" style="height:10px;">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%"></div>
          </div>
          <div class="small text-muted mt-2" id="progressStatus">Consultando servidor…</div>
        </div>
      </div>
    </div>

    <!-- Alertas -->
    <div id="alertContainer"></div>

    <!-- Resultados -->
    <div id="resultsSection" class="row mb-4 d-none">
      <div class="col-12">
        <div class="chart-container">
          <h5 class="mb-3"><i class="fas fa-chart-bar text-success"></i> Resultados de la Predicción</h5>
          <div id="predictionResults"></div>

          <!-- === acciones de reporte === -->
          <hr class="my-3">
          <div class="d-flex gap-2">
            <button id="btnVerReporte" class="btn btn-outline-primary" disabled>
              <i class="fas fa-chart-line me-1"></i> Ver gráfico y reporte
            </button>
            <button id="btnDescargarPDF" class="btn btn-outline-danger" disabled>
              <i class="fas fa-file-pdf me-1"></i> Descargar PDF
            </button>
            <button id="btnDescargarXLSX" class="btn btn-outline-success" disabled>
              <i class="fas fa-file-excel me-1"></i> Descargar XLSX
            </button>
          </div>

        </div>
      </div>
    </div>

    <!-- Historial -->
    <div class="row">
      <div class="col-12">
        <div class="chart-container">
          <h5 class="mb-3"><i class="fas fa-history text-info"></i> Historial de Predicciones</h5>
          <div id="predictionHistory">
            <div class="text-center text-muted py-5">
              <i class="fas fa-crystal-ball fa-3x text-muted mb-3"></i>
              <p class="fw-bold mb-1">No hay predicciones generadas aún</p>
              <p class="small text-muted">Las predicciones aparecerán aquí una vez que las generes</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  window.addEventListener('load', async () =>{
            try{
                // se obtienen los datos del usuario desde el servidor
                const response = await fetch('/api/perfil');

                if (!response.ok){
                    console.warn('Dev mode: perfil no disponible, se omite redirección al login');
                } else {
                    const usuario = await response.json();
                    if (usuario.nombre && usuario.apellido){
                        document.getElementById('welcomeMessage').innerText = `${usuario.nombre} ${usuario.apellido}`;
                    }
                    verificarAdmin(usuario.rol);
                }
            } catch (error){
                console.error('Error de autenticación: ', error);
                console.warn('Dev mode: se omite redirección al login');
            }
        });

        // Permisos
        function verificarAdmin(rol){
            console.log("Rol del usuario: ", rol);

            const dropdowns = {
                registrar: document.getElementById('dropdownRegistrar'),
                editarTrabajador: document.getElementById('dropdownEditarTrabajador'),
                editarCliente: document.getElementById('dropdownEditarCliente'),
                registrarCliente: document.getElementById('dropdownRegistrarCliente')
            };

            Object.values(dropdowns).forEach(dropdown => {
                if (dropdown) { 
                    dropdown.style.display = 'block';
                }
            });

            if (rol === 'Soporte TI' || rol === 'Gerente'){
                Object.values(dropdowns).forEach(dropdown =>{
                    dropdown.style.pointerEvents = 'auto';
                    dropdown.style.color = '';
                    dropdown.style.textDecoration= '';
                });
            } else if(rol === 'Supervisor'){
                Object.values(dropdowns).forEach(dropdown =>{
                    dropdown.style.pointerEvents = 'none';
                    dropdown.style.color = 'Gray';
                    dropdown.style.textDecoration= 'none';
                });
            }
        }

        async function logout() {
            try { await fetch('/logout', { method: 'POST', credentials: 'include' }); } catch (e) {}
            try { sessionStorage.clear(); localStorage.clear(); } catch (e) {}
            try {
                document.cookie.split(';').forEach(c => {
                    const eqPos = c.indexOf('=');
                    const name = (eqPos > -1 ? c.substring(0, eqPos) : c).trim();
                    if (name) document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
                });
            } catch (e) {}
            window.location.replace('login.html');
        }
/* === backend integrado === */
class StaffPredictionSystem{
  constructor(){
    this.progressSection=document.getElementById('progressSection');
    this.progressBar=document.getElementById('progressBar');
    this.progressText=document.getElementById('progressText');
    this.progressStatus=document.getElementById('progressStatus');
    this.alertContainer=document.getElementById('alertContainer');
    this.predictionHistory=document.getElementById('predictionHistory');
    this.resultsSection=document.getElementById('resultsSection');
    this.predictionResults=document.getElementById('predictionResults');
    this.totalPredEl=document.getElementById('totalPredictions');
    this.lastPredEl=document.getElementById('lastPrediction');
    this.predictions=JSON.parse(localStorage.getItem('staffPredictions')||'[]');
    this.renderPredictionHistory(); this.updateMetrics();
  }

  async entrenar(){
    try{
      this.showProgress('Preparando entrenamiento…',15);
      const r= await fetch(`${URL_BASE}/prediccion/entrenar`,
        {method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({})
      });
s
      const js=await r.json();
      this.hideProgress();
      if(!r.ok||!js.ok) throw new Error(js.error||js.mensaje||'Fallo al entrenar');
      this.showAlert('success','Entrenamiento listo. Ahora puedes proyectar.');
    }catch(e){
      this.hideProgress(); this.showAlert('error','No se pudo entrenar: '+e.message);
    }
  }

  async proyectar(){
    try{
      const anio=document.getElementById('anioInput').value.trim();
      const mes=document.getElementById('mesInput').value.trim();
      let url=`${URL_BASE}/prediccion/proyectar`;
      const qs=[]; if(anio) qs.push('anio='+encodeURIComponent(anio)); if(mes) qs.push('mes='+encodeURIComponent(mes));
      if(qs.length) url+='?'+qs.join('&');

      this.showProgress('Proyectando…',40);
      const r=await fetch(url); const js=await r.json(); this.hideProgress();
      if(!r.ok||!js.ok) throw new Error(js.error||js.mensaje||'Fallo en proyección');

      // Historial
      const item={id:Date.now(),createdDate:new Date().toLocaleString('es-CL'),resumen:`${js.mes_base.anio}-${js.mes_base.mes} → ${js.mes_siguiente.anio}-${js.mes_siguiente.mes}`,estado:js.mes_siguiente.estado_modelo||js.mes_siguiente.estado_regla};
      this.predictions.unshift(item); localStorage.setItem('staffPredictions',JSON.stringify(this.predictions));
      this.renderPredictionHistory(); this.updateMetrics();

      this.showResults(js);
      this.showAlert('success','Predicción generada correctamente.');
    }catch(e){
      this.hideProgress(); this.showAlert('error',e.message);
    }
  }

  showResults(js){
    const est=(js.mes_siguiente.estado_modelo||js.mes_siguiente.estado_regla||'').toLowerCase();
    const badge= est==='sobre' ? '<span class="badge bg-danger estado-badge">sobredotación</span>'
               : est==='sub'   ? '<span class="badge bg-warning text-dark estado-badge">subdotación</span>'
                               : '<span class="badge bg-success estado-badge">adecuado</span>';
    const html=`
      <div class="row">
        <div class="col-md-4 mb-3">
          <div class="result-card">
            <h6 class="text-white-50">Mes base</h6>
            <h4 class="text-white">${js.mes_base.anio}-${String(js.mes_base.mes).padStart(2,'0')}</h4>
            <small class="text-white-50">capacidad óptima: ${js.mes_base.capacidad_optima.toFixed(2)}</small>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="result-card success">
            <h6 class="text-white-50">Mes siguiente</h6>
            <h4 class="text-white">${js.mes_siguiente.anio}-${String(js.mes_siguiente.mes).padStart(2,'0')}</h4>
            <small class="text-white-50">producción: ${js.mes_siguiente.produccion_total}</small>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="result-card warning">
            <h6 class="text-white-50">Estado</h6>
            <h3 class="text-white">${badge}</h3>
            <small class="text-white-50">reales: ${js.mes_siguiente.trabajadores_reales} • necesarios: ${js.mes_siguiente.trabajadores_necesarios}</small>
          </div>
        </div>
      </div>`;
    this.predictionResults.innerHTML=html;
    this.resultsSection.classList.remove('d-none'); this.resultsSection.classList.add('fade-in');
  }

  renderPredictionHistory(){
    if(this.predictions.length===0){
      this.predictionHistory.innerHTML=`<div class="text-center text-muted py-5">
        <i class="fas fa-crystal-ball fa-3x text-muted mb-3"></i>
        <p class="fw-bold mb-1">No hay predicciones generadas aún</p>
        <p class="small text-muted">Las predicciones aparecerán aquí una vez que las generes</p>
      </div>`; return;
    }
    const toBadge=e=> e==='sobre' ? '<span class="badge bg-danger">sobre</span>' : e==='sub' ? '<span class="badge bg-warning text-dark">sub</span>' : '<span class="badge bg-success">ok</span>';
    this.predictionHistory.innerHTML=this.predictions.map(p=>`
      <div class="d-flex justify-content-between align-items-center p-3 mb-3 bg-light rounded border">
        <div class="d-flex align-items-center">
          <div class="me-3"><div class="bg-primary bg-opacity-10 rounded p-2"><i class="fas fa-crystal-ball text-primary"></i></div></div>
          <div><p class="mb-1 fw-bold">${p.resumen}</p></div>
        </div>
        <div>${toBadge(p.estado)}</div>
      </div>`).join('');
  }

  updateMetrics(){
    this.totalPredEl.textContent=this.predictions.length;
    this.lastPredEl.textContent=this.predictions[0]?.createdDate||'Sin predicciones';
  }

  showProgress(text='Procesando…',pct=20){
    this.progressSection.classList.remove('d-none'); this.updateProgress(pct,text);
    document.getElementById('predictionArea').classList.add('processing');
  }
  hideProgress(){ this.progressSection.classList.add('d-none'); this.updateProgress(0,''); document.getElementById('predictionArea').classList.remove('processing'); }
  updateProgress(p,status){ this.progressBar.style.width=`${p}%`; this.progressText.textContent=`${p}%`; this.progressStatus.textContent=status||''; }
  showAlert(type,message){
    const id=Date.now();
    const map={success:'alert-success',error:'alert-danger',info:'alert-info'};
    const iconMap={success:'fa-check-circle',error:'fa-exclamation-triangle',info:'fa-info-circle'};
    const cls=map[type]||'alert-info'; const icon=iconMap[type]||'fa-info-circle';
    const html=`<div id="a-${id}" class="alert ${cls} alert-dismissible fade show mb-4" role="alert">
      <i class="fas ${icon} me-2"></i>${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
    this.alertContainer.insertAdjacentHTML('beforeend',html);
    setTimeout(()=>{document.getElementById('a-'+id)?.remove();},5000);
  }
}
let predictor;
document.addEventListener('DOMContentLoaded',()=>{ predictor=new StaffPredictionSystem(); });
function generatePrediction(){ predictor.proyectar(); }
function entrenarModelo(){ predictor.entrenar(); }
function refreshPredictions(){ predictor.renderPredictionHistory(); predictor.updateMetrics(); predictor.showAlert('success','Datos actualizados'); }
function showComingSoon(){ predictor.showAlert('info','Próximamente'); }


// Almacena la última predicción y habilita botones sin modificar showResults original
(function(){
  const btnVer  = () => document.getElementById('btnVerReporte');
  const btnPDF  = () => document.getElementById('btnDescargarPDF');
  const btnXLSX = () => document.getElementById('btnDescargarXLSX');

  // Parchear showResults para guardar predicción y habilitar botones
  const _origShow = StaffPredictionSystem.prototype.showResults;
  StaffPredictionSystem.prototype.showResults = function(js){
    _origShow.call(this, js);
    window.__lastPrediction = js; // disponible global para export
    if (btnVer())  btnVer().disabled  = false;
    if (btnPDF())  btnPDF().disabled  = false;
    if (btnXLSX()) btnXLSX().disabled = false;
  };

  // Eventos botones 
  document.addEventListener('DOMContentLoaded', ()=>{
    btnVer()?.addEventListener('click', openReportModal);
    btnPDF()?.addEventListener('click', downloadPDF);
    btnXLSX()?.addEventListener('click', downloadXLSX);
    document.getElementById('btnPDFModal')?.addEventListener('click', downloadPDF);
    document.getElementById('btnXLSXModal')?.addEventListener('click', downloadXLSX);
  });

  let chartModalInstance = null;

  function openReportModal(){
    const js = window.__lastPrediction; if(!js) return;

    // Resumen textual
    const resumenHTML = `
      <p class="mb-1"><strong>Resumen:</strong> ${js.resumen || '—'}</p>
      <p class="mb-1"><strong>Base:</strong> ${js.mes_base.anio}-${String(js.mes_base.mes).padStart(2,'0')}
        · Capacidad óptima: ${Number(js.mes_base.capacidad_optima||0).toFixed(2)}</p>
      <p class="mb-1"><strong>Proyección:</strong> ${js.mes_siguiente.anio}-${String(js.mes_siguiente.mes).padStart(2,'0')}
        · Producción ${js.mes_siguiente.produccion_total}
        · Reales ${js.mes_siguiente.trabajadores_reales}
        · Necesarios ${js.mes_siguiente.trabajadores_necesarios}</p>
      <p class="text-muted small"><strong>Regla:</strong> ${js.reporte?.regla || '—'} · <strong>Nota:</strong> ${js.reporte?.notas || '—'}</p>
    `;
    document.getElementById('predictionSummary').innerHTML = resumenHTML;

    // Gráfico
    try{
      const ctx = document.getElementById('empleadosChartModal').getContext('2d');
      if(chartModalInstance){ chartModalInstance.destroy(); }
      chartModalInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: js.serie_empleados?.labels || [],
          datasets: [
            { label: 'Trabajadores reales', data: js.serie_empleados?.reales || [], tension: 0.3 },
            { label: 'Trabajadores necesarios', data: js.serie_empleados?.necesarios || [], tension: 0.3 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    }catch(e){ console.warn('No se pudo renderizar el gráfico', e); }

    // Mostrar modal
    const modalEl = document.getElementById('reporteModal');
    const bsModal = new bootstrap.Modal(modalEl);
    bsModal.show();
  }

  function downloadPDF(){
    const js = window.__lastPrediction; if(!js) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });

    doc.setFontSize(14);
    doc.text('Reporte de Predicción de Dotación', 40, 40);

    const txt = [
      js.resumen || '—',
      `Base: ${js.mes_base.anio}-${String(js.mes_base.mes).padStart(2,'0')} · Capacidad óptima: ${Number(js.mes_base.capacidad_optima||0).toFixed(2)}`,
      `Proyección: ${js.mes_siguiente.anio}-${String(js.mes_siguiente.mes).padStart(2,'0')} · Producción ${js.mes_siguiente.produccion_total} · Reales ${js.mes_siguiente.trabajadores_reales} · Necesarios ${js.mes_siguiente.trabajadores_necesarios}`,
      `Regla: ${js.reporte?.regla || '—'} · Nota: ${js.reporte?.notas || '—'}`
    ].join('\n');

    doc.setFontSize(11);
    const y0 = 70;
    const lines = doc.splitTextToSize(txt, 515);
    doc.text(lines, 40, y0);

    const canvas = document.getElementById('empleadosChartModal');
    if (canvas) {
      const dataURL = canvas.toDataURL('image/png', 1.0);
      doc.addImage(dataURL, 'PNG', 40, y0 + lines.length*14 + 14, 515, 260);
    }

    const fileName = `reporte_prediccion_${js.mes_siguiente.anio}-${String(js.mes_siguiente.mes).padStart(2,'0')}.pdf`;
    doc.save(fileName);
  }

  function downloadXLSX(){
    const js = window.__lastPrediction; if(!js) return;

    const rowsResumen = [
      ['Reporte de Predicción de Dotación', ''],
      ['Mes base', `${js.mes_base.anio}-${String(js.mes_base.mes).padStart(2,'0')}`],
      ['Capacidad óptima (base)', Number(js.mes_base.capacidad_optima||0)],
      ['Mes proyectado', `${js.mes_siguiente.anio}-${String(js.mes_siguiente.mes).padStart(2,'0')}`],
      ['Producción esperada', js.mes_siguiente.produccion_total],
      ['Trabajadores reales', js.mes_siguiente.trabajadores_reales],
      ['Trabajadores necesarios', js.mes_siguiente.trabajadores_necesarios],
      ['Estado', js.mes_siguiente.estado_regla || js.mes_siguiente.estado_modelo || ''],
      ['Regla', js.reporte?.regla || ''],
      ['Notas', js.reporte?.notas || '']
    ];

    const header = ['Mes', 'Reales', 'Necesarios'];
    const tabla = (js.serie_empleados?.labels || []).map((lab, i) => [
      lab,
      js.serie_empleados.reales?.[i] ?? null,
      js.serie_empleados.necesarios?.[i] ?? null
    ]);

    const wb = XLSX.utils.book_new();
    const ws1 = XLSX.utils.aoa_to_sheet(rowsResumen);
    const ws2 = XLSX.utils.aoa_to_sheet([header, ...tabla]);

    XLSX.utils.book_append_sheet(wb, ws1, 'Resumen');
    XLSX.utils.book_append_sheet(wb, ws2, 'SerieEmpleados');

    const file = `reporte_prediccion_${js.mes_siguiente.anio}-${String(js.mes_siguiente.mes).padStart(2,'0')}.xlsx`;
    XLSX.writeFile(wb, file);
  }
})();
</script>

<!-- === Modal de reporte === -->
<div class="modal fade" id="reporteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-file-alt me-2"></i>Reporte de predicción
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <canvas id="empleadosChartModal" height="140"></canvas>
        </div>
        <div id="predictionSummary" class="text-muted"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-danger" id="btnPDFModal">
          <i class="fas fa-file-pdf me-1"></i> Descargar PDF
        </button>
        <button class="btn btn-outline-success" id="btnXLSXModal">
          <i class="fas fa-file-excel me-1"></i> Descargar XLSX
        </button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>