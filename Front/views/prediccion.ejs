<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Predicción de Dotación - Sistema IA</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="config_server.js"></script>

  <style>
    /* === ESTÉTICA GENERAL === */
    body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }

    /* Cards de Métricas */
    .metric-card { 
      border-radius: 16px; color: #fff; padding: 20px; border: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s; position: relative; overflow: hidden;
    }
    .metric-card:hover { transform: translateY(-3px); }
    .metric-card.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .metric-card.success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .metric-card.warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .metric-card.info    { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    
    .metric-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); opacity: 0.3; font-size: 2.5rem; }

    /* Contenedores Blancos */
    .content-box { 
      background: #fff; border-radius: 16px; padding: 25px; 
      box-shadow: 0 5px 20px rgba(0,0,0,0.03); height: 100%; border: 1px solid rgba(0,0,0,0.02);
    }

    .section-title { font-weight: 700; color: #2d3748; margin-bottom: 20px; font-size: 1.1rem; }

    .form-select-custom, .form-control-custom { 
      background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px 15px; font-size: 0.9rem;
    }
    .form-select-custom:focus, .form-control-custom:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }

    .btn-action { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; 
      border-radius: 10px; padding: 12px; width: 100%; font-weight: 600; transition: all 0.3s; 
    }
    .btn-action:hover { opacity: 0.9; transform: translateY(-1px); color: white; }
    
    .history-item { 
      display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; 
    }
    .history-item:last-child { border-bottom: none; }
    .history-icon { 
      width: 40px; height: 40px; border-radius: 10px; background: #e0e7ff; color: #4f46e5; 
      display: flex; align-items: center; justify-content: center; margin-right: 15px; 
    }
    
    .badge-status { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; letter-spacing: 0.5px; }
    .bg-soft-success { background-color: #d1fae5; color: #065f46; }
    .bg-soft-danger { background-color: #fee2e2; color: #991b1b; }
    .bg-soft-warning { background-color: #fef3c7; color: #92400e; }

    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

    <%- include('partials/navbar') %>

    <div class="container-fluid px-4 py-4">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="fw-bold text-dark mb-0">Predicción de Dotación</h3>
                <p class="text-muted small mb-0">Modelo Híbrido: Regresión + Estacionalidad (MySQL)</p>
            </div>
            <div>
               <button class="btn btn-light border shadow-sm" onclick="app.actualizarGrafico()"><i class="fas fa-sync-alt text-muted"></i></button>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="metric-card primary h-100">
                    <p class="mb-1 opacity-75 small text-uppercase fw-bold">Predicciones Totales</p>
                    <h2 class="mb-0 fw-bold" id="totalPredictions">0</h2>
                    <i class="fas fa-chart-line metric-icon"></i>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="metric-card success h-100">
                    <p class="mb-1 opacity-75 small text-uppercase fw-bold">Precisión Modelo</p>
                    <h2 class="mb-0 fw-bold">±10%</h2>
                    <i class="fas fa-bullseye metric-icon"></i>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="metric-card warning h-100">
                    <p class="mb-1 opacity-75 small text-uppercase fw-bold">Última Proyección</p>
                    <h5 class="mb-0 fw-bold" id="lastPrediction">---</h5>
                    <i class="fas fa-clock metric-icon"></i>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="metric-card info h-100">
                    <p class="mb-1 opacity-75 small text-uppercase fw-bold">Estado IA</p>
                    <h5 class="mb-0 fw-bold">Auto-Learn</h5>
                    <i class="fas fa-robot metric-icon"></i>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="content-box">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="section-title m-0"><i class="fas fa-chart-area text-primary me-2"></i>Análisis Histórico Global</h5>
                    </div>

                    <!-- SECCIÓN DE FILTROS ELIMINADA -->

                    <div style="height: 380px;">
                        <canvas id="mainHistoryChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="content-box">
                    <h5 class="section-title">Configurar Proyección</h5>
                    
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold text-uppercase">Analizar Mes Específico</label>
                        <div class="d-flex g-2">
                            <select id="selMes" class="form-select form-select-custom me-2" style="width:50%">
                                <% for(let m=1;m<=12;m++){ %>
                                  <option value="<%= m %>"><%= m %></option>
                                <% } %>
                            </select>
                            <select id="selAnio" class="form-select form-select-custom" style="width:50%">
                                <!-- INICIO DESDE 2023 -->
                                <% for(let a=2023;a<=2030;a++){ %>
                                  <option value="<%= a %>"><%= a %></option>
                                <% } %>
                            </select>
                        </div>
                        <div class="mt-2 d-grid">
                          <button class="btn btn-outline-primary btn-sm" onclick="app.analizarMesEspecifico()">
                            <i class="fas fa-search me-1"></i> Analizar mes
                          </button>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-4">
                        <label class="form-label text-muted small fw-bold text-uppercase">Horizonte Temporal</label>
                        <select id="mesesInput" class="form-select form-select-custom">
                            <option value="1">1 Mes (Alta Precisión)</option>
                            <option value="3" selected>3 Meses (Trimestre)</option>
                            <option value="6">6 Meses (Semestre)</option>
                            <option value="12">12 Meses (Anual)</option>
                        </select>
                        <small class="text-muted" style="font-size: 0.75rem;">
                            <i class="fas fa-info-circle me-1"></i> La precisión disminuye en fechas lejanas.
                        </small>
                    </div>

                    <div class="d-grid gap-3 mb-3">
                        <button class="btn-action shadow-sm" onclick="app.proyectar()">
                            <i class="fas fa-magic me-2"></i> Generar Proyección
                        </button>
                        
                        <div class="text-center">
                            <small class="text-success fw-bold" style="font-size: 0.75rem;">
                                <i class="fas fa-check-circle me-1"></i> Modelo actualizado automáticamente
                            </small>
                        </div>
                    </div>

                    <hr class="text-muted opacity-25 my-2">

                    <h6 class="text-muted small fw-bold text-uppercase mb-3">Actividad Reciente</h6>
                    <div id="predictionHistory" style="max-height: 200px; overflow-y: auto;">
                        <div class="text-center text-muted py-3 small">Sin historial de sesión.</div>
                    </div>

                </div>
            </div>
        </div>

        <div id="resultsSection" class="row mt-4 d-none fade-in">
            <div class="col-12">
                <div class="content-box">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="section-title m-0 text-success">Resultados de Proyección</h5>
                        <div>
                          <button id="btnDescargarPDF" class="btn btn-sm btn-outline-primary">
                              <i class="fas fa-file-pdf me-1"></i> Descargar Informe PDF
                          </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">Periodo</th>
                                    <th>Producción Est.</th>
                                    <th>Rango (Min-Max)</th>
                                    <th>Factor Evento</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody"></tbody>
                        </table>
                    </div>

                    <div class="alert alert-light border mt-3 d-flex gap-3 align-items-center">
                        <i class="fas fa-info-circle text-info fa-lg"></i>
                        <small class="text-muted">
                            <strong>Nota de Modelo:</strong> Los cálculos excluyen ausencias justificadas (Vacaciones, Licencias Médicas) para determinar la productividad óptima real.
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div id="progressSection" class="d-none position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background: rgba(255,255,255,0.8); z-index: 9999;">
            <div class="bg-white p-4 rounded-4 shadow text-center border" style="width: 300px;">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <h6 class="fw-bold mb-2">Procesando IA...</h6>
                <div class="progress" style="height: 6px;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                </div>
                <small id="progressText" class="text-muted mt-2 d-block">0%</small>
            </div>
        </div>

    </div>

<script>
class StaffPredictionSystem {
  constructor(){
    this.progressSection = document.getElementById('progressSection');
    this.progressBar = document.getElementById('progressBar');
    this.progressText = document.getElementById('progressText');
    this.resultsSection = document.getElementById('resultsSection');
    this.tableBody = document.getElementById('resultsTableBody');
    this.historyContainer = document.getElementById('predictionHistory');

    this.predictions = JSON.parse(localStorage.getItem('staffPredictions') || '[]');

    this.lastHistoryData = null;
    this.chart = null;
    this.baseUrl = (typeof URL_BASE !== 'undefined') ? URL_BASE : '';

    this.renderHistory();
    this.updateMetrics();
    // this.cargarFiltros(); // Eliminado porque ya no existen los elementos DOM
    this.initChart();

    const pdfBtn = document.getElementById('btnDescargarPDF');
    if (pdfBtn) pdfBtn.addEventListener('click', () => this.descargarPDF());
  }

  // cargarFiltros() ELIMINADO

  initChart() { this.actualizarGrafico(); }

  async actualizarGrafico() {
    // Filtros vacíos para traer datos globales
    const filtros = {
        mandante: '',
        servicio: '',
        usuario: '',
        anio: ''
    };

    try {
        const r = await fetch(`${this.baseUrl}/prediccion/grafico-filtrado`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify(filtros)
        });
        const js = await r.json();

        if (!js.ok) { console.warn("grafico-filtrado no devolvió ok"); return; }
        if (!js.datos || !js.datos.length) {
          if (this.chart) { this.chart.destroy(); this.chart = null; }
          this.lastHistoryData = null;
          return;
        }

        this.lastHistoryData = js.datos.map(d => {
          let etiqueta = d.etiqueta;
          if (!etiqueta && d.anio && d.mes) etiqueta = `${d.anio}-${String(d.mes).padStart(2,'0')}`;
          return {
            etiqueta,
            valor: Number(d.valor || d.produccion || 0),
            anio: Number(d.anio || (etiqueta ? Number(etiqueta.split('-')[0]) : null)),
            mes: Number(d.mes || (etiqueta ? Number(etiqueta.split('-')[1]) : null)),
            estado: (d.estado || '').toString().toLowerCase() || null
          };
        });

        const pointColors = this.lastHistoryData.map(x => {
          const s = (x.estado || 'ok').toString().toLowerCase();
          if (s.includes('sobre')) return '#ef4444'; 
          if (s.includes('sub')) return '#f59e0b'; 
          return '#10b981'; 
        });

        const ctx = document.getElementById('mainHistoryChart').getContext('2d');
        if (this.chart) this.chart.destroy();

        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(102, 126, 234, 0.25)');
        gradient.addColorStop(1, 'rgba(102, 126, 234, 0.0)');

        this.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: this.lastHistoryData.map(d => d.etiqueta),
                datasets: [{
                    label: 'Producción Real',
                    data: this.lastHistoryData.map(d => d.valor),
                    borderColor: '#667eea',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointBackgroundColor: pointColors,
                    pointBorderColor: '#764ba2',
                    pointRadius: 5,
                    fill: true,
                    tension: 0.35
                }]
            },
            options: {
                responsive:true,
                maintainAspectRatio:false,
                plugins: {
                  legend: { display:false },
                  tooltip: {
                    callbacks: {
                      label: (ctx) => `Producción: ${ctx.parsed.y}`,
                      afterBody: (items) => {
                        const idx = items[0].dataIndex;
                        const st = (this.lastHistoryData[idx]?.estado || 'OK').toUpperCase();
                        return `Estado: ${st}`;
                      }
                    }
                  }
                },
                scales: {
                  y: { grid: { borderDash: [5,5] } },
                  x: { grid: { display: false } }
                }
            }
        });

    } catch (e) { console.error("Error actualizando gráfico:", e); }
  }

  async proyectar() {
    const meses = document.getElementById('mesesInput').value;
    
    // Filtros vacíos (ya no se leen del DOM)
    const mandante = '';
    const servicio = '';
    const usuario = '';

    this.showProgress(60);
    try {
        const queryParams = new URLSearchParams({
            meses: meses,
            mandante: mandante,
            servicio: servicio,
            usuario: usuario
        });

        const r = await fetch(`${this.baseUrl}/prediccion/proyectar?${queryParams.toString()}`);
        const js = await r.json();
        this.hideProgress();

        if(!js.ok) throw new Error(js.error || 'Error en proyección');

        window.__lastPrediction = js.proyecciones;
        this.renderResults(js.proyecciones);
        this.addToHistory(js.proyecciones);
        setTimeout(()=> this.resultsSection.scrollIntoView({behavior:'smooth'}), 200);
    } catch(e) {
        this.hideProgress();
        alert(e.message || e);
    }
  }

  async analizarMesEspecifico(){
    const mes = Number(document.getElementById('selMes').value);
    const anio = Number(document.getElementById('selAnio').value);

    try {
      const r = await fetch(`${this.baseUrl}/prediccion/analizar-mes?mes=${mes}&anio=${anio}`);
      const js = await r.json();
      if (js.ok) {
        const dto = {
          anio, mes,
          produccion: js.produccion ?? 0,
          rango_min: js.rango_min ?? Math.round((js.produccion||0)*0.9),
          rango_max: js.rango_max ?? Math.round((js.produccion||0)*1.1),
          factor: js.factor ?? '1.00',
          estado: js.estado || 'ok'
        };
        this.renderResults([dto]);
        window.__lastPrediction = [dto];
        return;
      }
    } catch(e) { console.warn('analizar-mes error', e); }

    if (!this.lastHistoryData) { alert("No hay datos históricos cargados."); return; }
    const etiqueta = `${anio}-${String(mes).padStart(2,'0')}`;
    const found = this.lastHistoryData.find(d => d.etiqueta === etiqueta);
    if (found) {
      const dto = {
        anio: found.anio,
        mes: found.mes,
        produccion: found.valor,
        rango_min: Math.round(found.valor*0.9),
        rango_max: Math.round(found.valor*1.1),
        factor: '1.00', estado: found.estado || 'ok'
      };
      this.renderResults([dto]);
      window.__lastPrediction = [dto];
    } else {
      alert("No se encontró el periodo en el historial.");
    }
  }

  renderResults(lista) {
    this.tableBody.innerHTML = '';
    lista.forEach(p => {
        let badge = `<span class="badge-status bg-soft-success">ADECUADO</span>`;
        const estadoNorm = (p.estado || '').toString().toLowerCase();
        
        if(estadoNorm.includes('sobredot')) badge = `<span class="badge-status bg-soft-danger">SOBREDOTACIÓN</span>`;
        else if(estadoNorm.includes('subdot')) badge = `<span class="badge-status bg-soft-warning">SUBDOTACIÓN</span>`;

        const tr = `
            <tr>
                <td class="ps-3 fw-bold text-dark">${p.anio}-${String(p.mes).padStart(2,'0')}</td>
                <td>${p.produccion}</td>
                <td class="text-muted small">${p.rango_min} - ${p.rango_max}</td>
                <td><span class="badge bg-light text-dark border">${p.factor}x</span></td>
                <td>${badge}</td>
            </tr>
        `;
        this.tableBody.innerHTML += tr;
    });
    this.resultsSection.classList.remove('d-none');
  }

  addToHistory(lista) {
      const inicio = lista[0];
      const fin = lista[lista.length-1];
      const resumen = `${inicio.anio}-${String(inicio.mes).padStart(2,'0')} → ${fin.anio}-${String(fin.mes).padStart(2,'0')}`;
      
      this.predictions.unshift({ id: Date.now(), date: new Date().toLocaleDateString(), resumen: resumen });
      localStorage.setItem('staffPredictions', JSON.stringify(this.predictions));
      this.renderHistory();
      this.updateMetrics();
  }

  renderHistory() {
      if(!this.predictions.length) {
          this.historyContainer.innerHTML = '<div class="text-center text-muted py-3 small">Sin historial reciente.</div>';
          return;
      }
      this.historyContainer.innerHTML = this.predictions.slice(0, 6).map(p => `
          <div class="history-item">
              <div class="history-icon"><i class="fas fa-magic"></i></div>
              <div>
                  <div class="fw-bold text-dark" style="font-size: 0.9rem;">Proyección Generada</div>
                  <div class="text-muted small">${p.resumen}</div>
                  <div class="text-muted small" style="font-size: 0.75rem;">${p.date}</div>
              </div>
          </div>
      `).join('');
  }

  updateMetrics() {
      document.getElementById('totalPredictions').innerText = this.predictions.length;
      if(this.predictions.length) document.getElementById('lastPrediction').innerText = this.predictions[0].date;
  }

  showProgress(pct) {
      this.progressSection.classList.remove('d-none');
      this.progressBar.style.width = pct + '%';
      this.progressText.innerText = pct + '%';
  }
  hideProgress() { this.progressSection.classList.add('d-none'); }

  async descargarPDF(){
    const btn = document.getElementById('btnDescargarPDF');
    const originalText = btn.innerHTML; 

    if (!window.__lastPrediction || !window.__lastPrediction.length) {
      alert("No hay proyección para exportar. Genera una proyección primero.");
      return;
    }

    try {
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando informe...';

      const r = await fetch(`${this.baseUrl}/prediccion/reporte`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ proyecciones: window.__lastPrediction })
      });

      if (!r.ok) {
        const txt = await r.text();
        throw new Error(txt || 'Error generando PDF');
      }

      const blob = await r.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Informe_Dotacion_${new Date().toISOString().slice(0,10)}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (e) {
      console.error("Error descargando PDF:", e);
      alert("No se pudo generar el informe.");
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }
}

let app;
document.addEventListener('DOMContentLoaded', () => { app = new StaffPredictionSystem(); });

window.addEventListener('load', async () => {
    try {
        const response = await fetch('/api/perfil', {
            method: 'GET',
            credentials: 'include', 
            headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
            const textoError = await response.text();
            console.error("Error del servidor:", textoError);
            console.warn("El sistema intentó desloguearte por el error de arriba.");
            
            window.location.href = 'login.html'; 
            return;
        }
        const usuario = await response.json();
        if (usuario.nombre && usuario.apellido) {
            const welcomeMsg = document.getElementById('welcomeMessage');
            if(welcomeMsg) welcomeMsg.innerText = `${usuario.nombre} ${usuario.apellido}`;
        }
        if (typeof cargarMandantes === 'function') cargarMandantes();

    } catch (error) {
        console.error('Error:', error);
    }
});
async function logout() {
    try { await fetch('/logout', { method: 'POST', credentials: 'include' }); } catch (e) {}
    try { sessionStorage.clear(); localStorage.clear(); } catch (e) {}
    try {
        document.cookie.split(';').forEach(c => {
            const eqPos = c.indexOf('=');
            const name = (eqPos > -1 ? c.substring(0, eqPos) : c).trim();
            if (name) document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
        });
    } catch (e) {}
    window.location.replace('login.html');
}
</script>

</body>
</html>