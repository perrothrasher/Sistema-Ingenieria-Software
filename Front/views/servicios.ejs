<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión - Inicio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="config_server.js"></script>
    <style>
        body {
            overflow-x: hidden;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .welcome-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
            padding: 15px;
        }
        
        .table tbody tr {
            transition: all 0.3s ease;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-color: #e9ecef;
        }
        
        .btn-action {
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            margin: 0 2px;
        }
        
        .btn-view {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-view:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .page-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #dee2e6;
        }
        .input-celda {
            border-radius: 0;
            box-shadow: none;
            font-size: 0.9rem;
            height: 100%;
            padding: 8px;
        }
        .input-celda:focus, .input-celda:hover {
            background-color: #f0f8ff;
            box-shadow: inset 0 0 0 2px #5a67d8;
        }
        .opcion-crear {
            font-weight: bold;
            color: #2C62C7;
            background-color: #eef2ff;
        }
        #tablaIngreso td {
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="container-fluid mt-4">
    
    <div class="row mb-3 align-items-center fade-in">
        <div class="col-md-8">
            <h2 class="fw-bold" style="color: #2C62C7;">
                <i class="fas fa-edit me-2"></i>Ingreso de Producción
            </h2>
            <p class="text-muted mb-0">
                Rellena los campos para registrar la producción diaria. Puedes agregar múltiples filas antes de guardar.
            </p>
        </div>
        <div class="col-md-4 text-end">
            <button id="btnGuardar" type="button" class="btn btn-success btn-lg shadow-sm" onclick="guardarTodo()" disabled>
                <i class="fas fa-save me-2"></i> Guardar Registros
            </button>
        </div>
    </div>

    <div class="card shadow-sm border-0 fade-in">
        <div class="card-body p-0"> <form id="formPlanilla">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0 align-middle" id="tablaIngreso">
                        <thead class="bg-light text-center">
                            <tr style="border-bottom: 2px solid #2C62C7;">
                                <th style="width: 3%;">#</th>
                                <th style="width: 20%;">Usuario <small>(Nombre + Apellido)</small></th>
                                <th style="width: 12%;">Tipo Servicio</th>
                                <th style="width: 10%;">Cantidad</th>
                                <th style="width: 15%;">Mandante</th>
                                <th style="width: 15%;">Fecha</th>
                                <th style="width: 15%;">Justificación</th>
                                <th style="width: 5%;"><i class="fas fa-trash-alt"></i></th> </tr>
                            </tr>
                        </thead>
                        <tbody id="cuerpoTabla">
                            </tbody>
                    </table>
                </div>
            </form>
            
            <div class="p-3 bg-light border-top text-center">
                <button type="button" class="btn btn-outline-primary dashed-border" onclick="agregarFilaVacia()">
                    <i class="fas fa-plus-circle me-2"></i> Agregar otra línea vacía
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNuevoMandante" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Nuevo Mandante</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control" id="inputNuevoMandante" placeholder="Nombre de la empresa...">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="guardarMandanteModal()">Crear</button>
            </div>
        </div>
    </div>
</div>

    <script>
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/api/perfil', {
                    method: 'GET',
                    credentials: 'include', 
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const textoError = await response.text();
                    console.error("Error del servidor:", textoError);
                    console.warn("El sistema intentó desloguearte por el error de arriba.");
                    
                    window.location.href = 'login.html'; 
                    return;
                }
                const usuario = await response.json();
                if (usuario.nombre && usuario.apellido) {
                    const welcomeMsg = document.getElementById('welcomeMessage');
                    if(welcomeMsg) welcomeMsg.innerText = `${usuario.nombre} ${usuario.apellido}`;
                }
                if (typeof cargarMandantes === 'function') cargarMandantes();

            } catch (error) {
                console.error('Error:', error);
            }
        });

        async function logout() {
            try { await fetch('/logout', { method: 'POST', credentials: 'include' }); } catch (e) {}
            try { sessionStorage.clear(); localStorage.clear(); } catch (e) {}
            try {
                document.cookie.split(';').forEach(c => {
                    const eqPos = c.indexOf('=');
                    const name = (eqPos > -1 ? c.substring(0, eqPos) : c).trim();
                    if (name) document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
                });
            } catch (e) {}
            window.location.replace('login.html');
        }

        let contador = 0;
        let listaUsuarios = []; 
        let listaServicios = [];
        let listaMandantes = [];
        let selectMandanteActivo = null;

        window.addEventListener('load', async () => {
            try {
                const resUsers = await fetch('/get-usuarios'); 
                const dataUsers = await resUsers.json();
                console.log("Datos usuarios:", dataUsers);
                listaUsuarios = dataUsers.usuarios || [];

                const resMandantes = await fetch('/get-mandantes');
                const dataMandantes = await resMandantes.json();
                listaMandantes = dataMandantes.mandantes || [];

                listaServicios = [
                    {id: 1, nombre: "Prenda"}, 
                    {id: 2, nombre: "Prendas Demo"},
                    {id: 3, nombre: "Rectificación en RNVM"},
                    {id: 4, nombre: "Cambio de Garantía"},
                    {id: 5, nombre: "Solo Prenda"},
                    {id: 6, nombre: "Portabilidad"}
                ];

                agregarFilaVacia();
            } catch (error) {
                console.error("Error cargando listas:", error);
            }
        });

        

    function validarFormulario() {
        const filas = document.querySelectorAll('#cuerpoTabla tr');
        const btnGuardar = document.getElementById('btnGuardar');
        let todoCompleto = true;
        let hayFilas = filas.length > 0;

        if (!hayFilas) {
            btnGuardar.disabled = true;
            return;
        }

        filas.forEach(tr => {
            const usuario = tr.querySelector('[name="usuario"]').value;
            const servicio = tr.querySelector('[name="servicio"]').value;
            const cantidad = tr.querySelector('[name="cantidad"]').value;
            const mandante = tr.querySelector('[name="mandante"]').value;
            const mes = tr.querySelector('[name="mes"]').value;
            const anio = tr.querySelector('[name="anio"]').value;


            if (!usuario || !servicio || !cantidad || !mandante || !mes || !anio) {
                todoCompleto = false;
            }
        });
        btnGuardar.disabled = !todoCompleto;
    }

    function agregarFilaVacia() {
        contador++;
        const tbody = document.getElementById('cuerpoTabla');
        const tr = document.createElement('tr');
        tr.id = `fila_${contador}`;
        
        const optsUsers = listaUsuarios.map(u => `<option value="${u.id}">${u.primer_nombre} ${u.primer_apellido}</option>`).join('');
        const optsMandantes = listaMandantes.map(m => `<option value="${m.id}">${m.nombre}</option>`).join('');
        const optsServs = listaServicios.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');

        tr.innerHTML = `
            <td class="text-center bg-light text-muted">${contador}</td>
            
            <td class="p-0">
                <select class="form-select input-celda border-0" name="usuario" onchange="validarFormulario()">
                    <option value="" selected disabled>- Seleccionar -</option>
                    ${optsUsers}
                </select>
            </td>
            
            <td class="p-0">
                <select class="form-select input-celda border-0" name="servicio" onchange="validarFormulario()">
                    <option value="" selected disabled>- Seleccionar -</option>
                    ${optsServs}
                </select>
            </td>

            <td class="p-0">
                <input type="number" class="form-control input-celda border-0 text-center" placeholder="0" min="0" name="cantidad" oninput="validarFormulario()">
            </td>

            <td class="p-0">
                <select class="form-select input-celda border-0" name="mandante" onchange="validarFormulario()">
                    <option value="" selected disabled>- Seleccionar -</option>
                    ${optsMandantes}
                </select>
            </td>

            <td class="p-0">
                <div class="d-flex">
                    <select class="form-select input-celda border-0" style="width: 60%;" name="mes" onchange="validarFormulario()">
                        <option value="" selected disabled>-mes-</option>
                        <option value="1">Ene</option>
                        <option value="2">Feb</option>
                        <option value="3">Mar</option>
                        <option value="4">Abr</option>
                        <option value="5">May</option>
                        <option value="6">Jun</option>
                        <option value="7">Jul</option>
                        <option value="8">Ago</option>
                        <option value="9">Sep</option>
                        <option value="10">Oct</option>
                        <option value="11">Nov</option>
                        <option value="12">Dic</option>
                    </select>
                    <select class="form-select input-celda border-0 border-start" style="width: 40%;" name="anio" onchange="validarFormulario()">
                        <option value="" selected disabled>-año-</option>
                        <option value="2020">2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
            </td>

            <td class="p-0">
                <select class="form-select input-celda border-0 text-center" name="justificacion">
                    <option value="1" selected>-- Sin Justificación --</option>
                    <option value="2" style="color:orange;">Vacaciones</option>
                    <option value="3" style="color:red;">Licencia Médica</option>
                    <option value="4">Otro</option>
                </select>
            </td>

            <td class="text-center p-1">
                <button type="button" class="btn btn-sm btn-danger" onclick="eliminarFila(${contador})">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
        
        validarFormulario();
    }

    function eliminarFila(id) {
        const fila = document.getElementById(`fila_${id}`);
        if(fila) fila.remove();
        validarFormulario();
    }

    async function guardarTodo() {
        const filas = document.querySelectorAll('#cuerpoTabla tr');
        const datosParaEnviar = [];

        filas.forEach(tr => {
            const usuario = tr.querySelector('[name="usuario"]').value;
            const servicio = tr.querySelector('[name="servicio"]').value;
            const cantidad = tr.querySelector('[name="cantidad"]').value;
            const mandante = tr.querySelector('[name="mandante"]').value;
            const mes = tr.querySelector('[name="mes"]').value;
            const anio = tr.querySelector('[name="anio"]').value;
            const justificacion = tr.querySelector('[name="justificacion"]').value;

            if (usuario && servicio && mandante) {
                datosParaEnviar.push({
                    id_usuario: usuario,
                    id_tipo_servicio: servicio,
                    cantidad: cantidad || 0, 
                    id_mandante: mandante,
                    mes: mes,
                    anio: anio,
                    id_justificacion: justificacion
                });
            }
        });

        if (datosParaEnviar.length === 0) {
            alert("No hay datos completos para guardar.");
            return;
        }

        try {
            const response = await fetch('/registrar-produccion-masiva', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datosParaEnviar)
            });
            
            if(response.ok) {
                alert("¡Datos guardados correctamente!");
                document.getElementById('cuerpoTabla').innerHTML = '';
                agregarFilaVacia();
            } else {
                alert("Hubo un error al guardar.");
            }
        } catch (e) {
            console.error(e);
            alert("Error de conexión.");
        }
    }
    </script>
</body>
</html>