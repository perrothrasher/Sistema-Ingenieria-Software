<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editar Cliente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="config_server.js"></script>
  <style>
    .form-container {
      max-width: 500px;
      margin: 20px auto;
      background-color: #f4f4f4;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      margin-top: 30px;
    }

    form input, form button {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      background-color: #28a745;
      color: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }

    button i {
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
    <div class="top-bar d-flex align-items-center">
        <div class="container-fluid">
            <nav class="navbar navbar-expand-lg w-100">
                <a class="navbar-brand" href="#">
    <img src="assets/totalcheck-logo.png" alt="TotalCheck Logo" style="height:30px; width:auto;">
</a>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="index.html">
                                <i class="fas fa-home"></i> Inicio
                            </a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-edit"></i> Editar
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" id="dropdownEditarCliente" href="editar_cliente.html">
                                    <i class="fas fa-user-edit"></i> Editar Clientes</a></li>
                                <li><a class="dropdown-item" href="ver_cliente.html">
                                    <i class="fas fa-users"></i> Ver Clientes</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" id="dropdownEditarTrabajador" href="editar_trabajador.html">
                                    <i class="fas fa-user-tie"></i> Editar Trabajador</a></li>
                                <li><a class="dropdown-item" href="ver_trabajador.html">
                                    <i class="fas fa-users-cog"></i> Ver Trabajadores</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-plus"></i> Agregar
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" id="dropdownRegistrarCliente" href="registro_cliente.html">
                                    <i class="fas fa-user-plus"></i> Agregar Clientes</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" id="dropdownRegistrar" href="registro2.html">
                                    <i class="fas fa-user-plus"></i> Agregar Trabajador</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-chart-line"></i> Dotación
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="dotacion_personal.html">
                                    <i class="fas fa-users"></i> Agregar Dotación</a></li>
                                <li><a class="dropdown-item" href="carga_datos_historicos.html">
                                    <i class="fas fa-upload"></i> Cargar Datos</a></li>
                                <li><a class="dropdown-item" href="visualizar_datos_historicos.html">
                                    <i class="fas fa-chart-bar"></i> Visualizar Datos</a></li>
                                <li><a class="dropdown-item" href="predicción.html">
                                    <i class="fas fa-crystal-ball"></i> Ver Predicción</a></li>
                            </ul>
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle"></i> <span id="welcomeMessage">Usuario</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
      </nav>
  </nav>
        </div>
    </div>

  <div class="container">
    <h1><i class="fas fa-user-plus"></i> Editar Cliente</h1>
    <form id="editarForm" method="post">
      <input type="text" id="nombre" name="nombre" placeholder="Nombre" required>
      <input type="text" id="apellido" name="apellido" placeholder="Apellido" required>
      <input type="text" id="rut" name="rut" placeholder="RUT" required>
      <select id="region_id" name="region_id" required>
        <option value="" disabled selected>Seleccione una región</option>
        <option value="1">Arica y Parinacota</option>
        <option value="2">Tarapacá</option>
        <option value="3">Antofagasta</option>
        <option value="4">Atacama</option>
        <option value="5">Coquimbo</option>
        <option value="6">Valparaíso</option>
        <option value="7">Región Metropolitana de Santiago</option>
        <option value="8">O’Higgins</option>
        <option value="9">Maule</option>
        <option value="10">Ñuble</option>
        <option value="11">Biobío</option>
        <option value="12">La Araucanía</option>
        <option value="13">Los Ríos</option>
        <option value="14">Los Lagos</option>
        <option value="15">Aysén del General Carlos Ibáñez del Campo</option>
        <option value="16">Magallanes y de la Antártica Chilena</option>
      </select>
      <input type="text" id="comuna" name="comuna" placeholder="Comuna" required>
      <input type="text" id="direccion" name="direccion" placeholder="Dirección" required>
      <input type="text" id="codigo_postal" name="codigo_postal" placeholder="Código Postal" required>
      <input type="text" id="telefono" name="telefono" placeholder="Teléfono" required>
      <input type="email" id="correo" name="correo" placeholder="Correo" required>
      <button type="submit">Actualizar Cliente</button>
    </form>
  </div>

  <script>
    function isDev(){
      try { return location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1'; }
      catch(_) { return true; }
    }

    window.addEventListener('load', async () =>{
            try{
                // se obtienen los datos del usuario desde el servidor
                const response = await fetch('/api/perfil');

                if (!response.ok){
                    if (isDev()) {
                      console.warn('Dev mode: perfil no disponible, se omite redirección al login');
                    } else {
                      window.location.href = 'login.html';
                      return;
                    }
                } else {
                    const usuario = await response.json();
                    if (usuario.nombre && usuario.apellido){
                        document.getElementById('welcomeMessage').innerText = `${usuario.nombre} ${usuario.apellido}`;
                    }
                    verificarAdmin(usuario.rol);
                }
            } catch (error){
                console.error('Error de autenticación: ', error);
                if (!isDev()) window.location.href = 'login.html';
            }
        });

        // PERMISOS
        function verificarAdmin(rol){
            console.log("Rol del usuario: ", rol);

            const dropdowns = {
                registrar: document.getElementById('dropdownRegistrar'),
                editarTrabajador: document.getElementById('dropdownEditarTrabajador'),
                editarCliente: document.getElementById('dropdownEditarCliente'),
                registrarCliente: document.getElementById('dropdownRegistrarCliente')
            };

            Object.values(dropdowns).forEach(dropdown => {
                dropdown.style.display = 'block';
            });

            if (rol === 'Soporte TI' || rol === 'Gerente'){
                Object.values(dropdowns).forEach(dropdown =>{
                    dropdown.style.pointerEvents = 'auto';
                    dropdown.style.color = '';
                    dropdown.style.textDecoration= '';
                });
            } else if(rol === 'Supervisor'){
                Object.values(dropdowns).forEach(dropdown =>{
                    dropdown.style.pointerEvents = 'none';
                    dropdown.style.color = 'Gray';
                    dropdown.style.textDecoration= 'none';
                });
            }
        }

    async function logout() {
      try { await fetch('/logout', { method: 'POST', credentials: 'include' }); } catch (e) {}
      try { sessionStorage.clear(); localStorage.clear(); } catch (e) {}
      try {
        document.cookie.split(';').forEach(c => {
          const eqPos = c.indexOf('=');
          const name = (eqPos > -1 ? c.substring(0, eqPos) : c).trim();
          if (name) document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
        });
      } catch (e) {}
      window.location.replace('login.html');
    }

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');

    async function cargarCliente(id) {
      try {
        const response = await fetch(`${URL_BASE}/get-clientes?id=${id}`);
        const data = await response.json();

        console.log('Datos del cliente:', data); 

        if (data.clientes && data.clientes.length > 0) {
          const cliente = data.clientes.find(cliente => cliente.id === parseInt(id)); // Filtra el cliente por el ID

          document.getElementById('nombre').value = cliente.nombre || '';
          document.getElementById('apellido').value = cliente.apellido || '';
          document.getElementById('rut').value = cliente.rut || '';

          const regionSelect = document.getElementById('region_id');
          regionSelect.value = cliente.region_id || '';

          document.getElementById('comuna').value = cliente.ciudad || '';
          document.getElementById('direccion').value = cliente.direccion || '';
          document.getElementById('codigo_postal').value = cliente.postal || '';
          document.getElementById('telefono').value = cliente.telefono || '';
          document.getElementById('correo').value = cliente.correo || '';
          
        } else {
          alert('Cliente no encontrado');
        }
      } catch (error) {
        console.error('Error al obtener los datos del cliente:', error);
        alert('Error al cargar los datos del cliente.');
      }
    }

    cargarCliente(id);

    document.getElementById('editarForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const updatedCliente = {
        id,
        nombre: document.getElementById('nombre').value,
        apellido: document.getElementById('apellido').value,
        rut: document.getElementById('rut').value,
        correo: document.getElementById('correo').value,
        telefono: document.getElementById('telefono').value,
        direccion: document.getElementById('direccion').value,
        ciudad: document.getElementById('comuna').value,
        region_id: document.getElementById('region_id').value,
        postal: document.getElementById('codigo_postal').value
      };

      console.log('Datos enviados para actualizar el cliente:', updatedCliente); 

      try {
        const response = await fetch(`${URL_BASE}/editarCliente/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatedCliente)
        });

        const result = await response.json();
        if (response.ok) {
          alert('Cliente actualizado con éxito');
          // Redirigir al usuario de vuelta a la página de clientes
          window.location.href = 'editar_cliente.html';
        } else {
          alert(result.message || 'Error al actualizar el cliente');
        }
      } catch (error) {
        console.error('Error al actualizar el cliente:', error);
        alert('Hubo un error al actualizar el cliente.');
      }
    });
  </script>
</body>
</html>

