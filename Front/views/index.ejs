<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">

    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .welcome-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px; /* Ajustado padding */
            margin-bottom: 30px;
            text-align: center;
        }
        
        .welcome-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        /* TUS ESTILOS DE TARJETAS KPI */
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
            height: 100%; /* Para que tengan la misma altura */
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 10px 20px rgba(118, 75, 162, 0.3);
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stats-label {
            font-size: 1.1rem;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .stats-sub {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* Estilo para las tarjetas de gráficos */
        .chart-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            padding: 20px;
            height: 100%;
        }

        .fade-in { animation: fadeIn 0.6s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>
    
    <div class="container-fluid mt-4 mb-5">
        
        <div class="row mb-4">
            <div class="col-12">
                <div class="welcome-section fade-in">
                    <h1 class="welcome-title">
                        <img src="assets/totalcheck-logo.png" alt="TotalCheck" style="height: 60px; width: auto;"><br>
                    </h1>
                    <div class="card border-0 shadow-sm p-3 mt-4 mx-auto" style="max-width: 900px;"> 
                    <div class="d-flex flex-wrap align-items-center justify-content-center gap-3">
                        
                        <div class="d-flex align-items-center text-muted">
                            <i class="fas fa-filter me-2"></i>
                            <span class="fw-bold">Filtrar por:</span>
                        </div>

                        <div style="min-width: 120px;">
                            <select class="form-select" id="filtroAnio">
                                <option value="">Todos los Años</option>
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>

                        <div style="min-width: 150px;">
                            <select class="form-select" id="filtroMes">
                                <option value="" selected>Todos los Meses</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>

                        <button class="btn btn-primary px-4" style="width: auto;" onclick="aplicarFiltros()">
                            <i class="fas fa-search me-1"></i> Filtrar
                        </button>

                        <button class="btn btn-secondary px-4" style="width: auto;" onclick="reiniciarFiltros()">
                            <i class="fas fa-undo me-1"></i> Reiniciar
                        </button>

                    </div>
                </div>
                </div>
            </div>
        </div>

        <div class="row mb-4 fade-in">
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-icon mb-2"><i class="fas fa-layer-group fa-2x"></i></div>
                    <div class="stats-number" id="kpiTotal">0</div>
                    <div class="stats-label">Producción Mensual</div>
                    <div class="stats-sub">Mes Actual</div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="stats-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); box-shadow: 0 10px 20px rgba(17, 153, 142, 0.3);">
                    <div class="stats-icon mb-2"><i class="fas fa-building fa-2x"></i></div>
                    <div class="stats-number" style="font-size: 1.8rem;" id="kpiCliente">...</div>
                    <div class="stats-label">Cliente Top</div>
                    <div class="stats-sub" id="kpiClienteCant">0 Folios</div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); box-shadow: 0 10px 20px rgba(245, 87, 108, 0.3);">
                    <div class="stats-icon mb-2"><i class="fas fa-user-tie fa-2x"></i></div>
                    <div class="stats-number" style="font-size: 1.8rem;" id="kpiUsuario">...</div>
                    <div class="stats-label">Operario Estrella</div>
                    <div class="stats-sub" id="kpiUsuarioCant">0 Folios</div>
                </div>
            </div>
        </div>

        <div class="row mb-5 fade-in">
            <div class="col-lg-8 mb-4 mb-lg-0">
                <div class="chart-card">
                    <h5 class="fw-bold text-secondary mb-4">Tendencia de Producción</h5> <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="graficoTendencia"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-card">
                    <h5 class="fw-bold text-secondary mb-4">Distribución por Servicio</h5>
                    <div style="position: relative; height: 250px; width: 100%;">
                        <canvas id="graficoDonut"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row fade-in mb-5"> <div class="col-lg-8 mb-4 mb-lg-0">
                <div class="chart-card">
                    <h5 class="fw-bold text-secondary mb-4">Dotación Activa Mensual</h5>
                    <div style="position: relative; height: 250px; width: 100%;">
                        <canvas id="graficoBarrasUsuarios"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="chart-card">
                    <h5 class="fw-bold text-secondary mb-4">Motivos de Baja (Excepciones)</h5>
                    <div style="position: relative; height: 250px; width: 100%;">
                        <canvas id="graficoPieJustificacion"></canvas>
                    </div>
                    <div class="text-center mt-2 text-muted small">
                        * Excluye registros normales
                    </div>
                </div>
            </div>
    
    </div>

    <footer class="mt-auto py-3" style="background-color: #f8f9fa; border-top: 1px solid #e9ecef;">
        <div class="container-fluid px-4">
            <div class="row align-items-center justify-content-between small text-muted">
                
                <div class="col-md-4">
                    <span class="fw-bold text-primary">TotalCheck</span> &copy; <span id="year"></span>
                    <span class="mx-2">|</span>
                    Desarrollado para Ingenieria en Software
                </div>

                <div class="col-md-4 text-end d-none d-md-block">
                    <span class="badge bg-success bg-opacity-10 text-success border border-success rounded-pill px-3">
                        <i class="fas fa-check-circle me-1"></i> Sistema Operativo
                    </span>
                    <span class="ms-3 text-muted">v 0.0.8 (Beta)</span>
                </div>

            

            </div>
        </div>
    </footer>

<script>
    document.getElementById('year').textContent = new Date().getFullYear();
</script>

<style>
    .hover-primary:hover {
        color: #4f46e5 !important; 
        text-decoration: underline !important;
    }
   body {
        display: flex;           
        flex-direction: column; 
        min-height: 100vh;      
    }
    .container-fluid.mt-4.mb-5 {
        flex: 1; 
    }
</style>

    <script>
        let chartLinea = null;
        let chartDonut = null;
        let chartBarras = null;
        let chartPie = null;

        // Función Logout
        async function logout() {
            try { await fetch('/logout', { method: 'POST', credentials: 'include' }); } catch (e) {}
            try { sessionStorage.clear(); localStorage.clear(); } catch (e) {}
            try {
                document.cookie.split(';').forEach(c => {
                    const eqPos = c.indexOf('=');
                    const name = (eqPos > -1 ? c.substring(0, eqPos) : c).trim();
                    if (name) document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
                });
            } catch (e) {}
            window.location.replace('login.html');
        }

        // Inicialización al cargar la página
        window.addEventListener('load', async () => {
            try {
                // 2. Verificar Sesión
                const response = await fetch('/api/perfil', {
                    method: 'GET',
                    credentials: 'include', 
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    console.warn("Sesión no válida. Redirigiendo...");
                    window.location.href = 'login.html'; 
                    return;
                }
                
                const usuario = await response.json();
                if (usuario.nombre && usuario.apellido) {
                    const welcomeMsg = document.getElementById('welcomeMessage');
                    if(welcomeMsg) welcomeMsg.innerText = `${usuario.nombre} ${usuario.apellido}`;
                }

                // 3. Cargar datos del Dashboard (con filtros por defecto)
                aplicarFiltros();

            } catch (error) {
                console.error('Error de inicialización:', error);
            }
        });

        // Función principal
        async function cargarDatos(anio = '', mes = '') {
            let query = '';
            if(anio) query += `anio=${anio}&`;
            if(mes) query += `mes=${mes}`;

            try {
                // 1. KPIs (Ya filtran por mes en el backend)
                const resKPI = await fetch(`/api/dashboard/kpis?${query}`, { credentials: 'include' });
                const dataKPI = await resKPI.json();
                actualizarTarjetas(dataKPI);

                // 2. Gráficos
                const resGraph = await fetch(`/api/dashboard/graficos?${query}`, { credentials: 'include' });
                const dataGraph = await resGraph.json();
                
                // Pasamos el MES seleccionado para saber cual resaltar
                actualizarGraficos(dataGraph, mes);

            } catch (error) {
                console.error("Error cargando datos:", error);
            }
        }

        function aplicarFiltros() {
            const anio = document.getElementById('filtroAnio').value;
            const mes = document.getElementById('filtroMes').value;
            cargarDatos(anio, mes);
        }

        function reiniciarFiltros() {
            document.getElementById('filtroAnio').value = "2025";
            document.getElementById('filtroMes').value = ""; // Reset a "Todos"
            cargarDatos("2025", "");
        }

        function actualizarTarjetas(data) {
            document.getElementById('kpiTotal').innerText = data.produccion_mensual.toLocaleString('es-CL');
            document.getElementById('kpiCliente').innerText = data.top_cliente;
            document.getElementById('kpiClienteCant').innerText = data.top_cliente_cantidad + " Folios";
            document.getElementById('kpiUsuario').innerText = data.top_usuario;
            document.getElementById('kpiUsuarioCant').innerText = data.top_usuario_cantidad + " Folios";
        }

        function actualizarGraficos(datos, mesSeleccionado) {
            // 1. Limpiar viejos
            if (chartLinea) chartLinea.destroy();
            if (chartDonut) chartDonut.destroy();
            if (chartBarras) chartBarras.destroy();
            if (chartPie) chartPie.destroy();
            
            // --- LÓGICA DE RESALTADO (Highlight) ---
            const pointBackgroundColors = [];
            const pointRadiuses = [];
            const pointBorderColors = [];
            const indiceMes = mesSeleccionado ? parseInt(mesSeleccionado) - 1 : -1;

            datos.tendencia.forEach((val, index) => {
                if (index === indiceMes) {
                    // SI ES EL MES SELECCIONADO: Punto Grande y Rojo
                    pointBackgroundColors.push('#ff5b5b'); 
                    pointBorderColors.push('#ff5b5b');
                    pointRadiuses.push(8); 
                } else {
                    // MES NORMAL
                    pointBackgroundColors.push('#fff');
                    pointBorderColors.push('#667eea');
                    pointRadiuses.push(4);
                }
            });

            // --- 2. GRÁFICO LÍNEA ---
            const ctxLine = document.getElementById('graficoTendencia').getContext('2d');
            chartLinea = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                    datasets: [{
                        label: 'Producción',
                        data: datos.tendencia,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: pointBackgroundColors,
                        pointBorderColor: pointBorderColors,
                        pointRadius: pointRadiuses,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [5, 5] } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // --- 3. GRÁFICO DONUT ---
            const ctxDonut = document.getElementById('graficoDonut').getContext('2d');
            
            const labelsServicios = datos.servicios.map(s => s.nombre);
            const dataServicios = datos.servicios.map(s => s.total);
            const colores = ['#38ef7d', '#f5576c', '#f093fb', '#4f46e5', '#fbbf24', '#22d3ee'];

            if (dataServicios.length === 0) {
                labelsServicios.push("Sin datos");
                dataServicios.push(1);
                colores[0] = "#e5e7eb";
            }

            chartDonut = new Chart(ctxDonut, {
                type: 'doughnut',
                data: {
                    labels: labelsServicios,
                    datasets: [{
                        data: dataServicios,
                        backgroundColor: colores,
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                    },
                    cutout: '70%'
                }
            });

        const ctxBar = document.getElementById('graficoBarrasUsuarios').getContext('2d');
        const barColors = datos.usuariosActivos.map((val, index) => {
            const indiceMes = mesSeleccionado ? parseInt(mesSeleccionado) - 1 : -1;
            return index === indiceMes ? '#ff9f43' : '#54a0ff'; 
        });

        chartBarras = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                datasets: [{
                    label: 'Usuarios Activos',
                    data: datos.usuariosActivos,
                    backgroundColor: barColors,
                    borderRadius: 5, 
                    barPercentage: 0.6 
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.raw + ' Operarios';
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { borderDash: [5, 5] },
                        ticks: { precision: 0 }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
        // --- GRÁFICO PIE ---
        const ctxPie = document.getElementById('graficoPieJustificacion').getContext('2d');
        
        let labelsJust = datos.justificaciones.map(j => j.nombre);
        let dataJust = datos.justificaciones.map(j => j.total);
        let colorsJust = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9f43'];

        if (dataJust.length === 0) {
            labelsJust = ["Sin Excepciones"];
            dataJust = [1];
            colorsJust = ["#e5e7eb"]; 
        }

        chartPie = new Chart(ctxPie, {
            type: 'pie', 
            data: {
                labels: labelsJust,
                datasets: [{
                    data: dataJust,
                    backgroundColor: colorsJust,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 10 } }
                }
            }
        });
        }
    </script>
</body>
</html>