<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editar Trabajador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .form-container {
      max-width: 500px;
      margin: 20px auto;
      background-color: #f4f4f4;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      margin-top: 30px;
    }

    form input, form button {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      background-color: #28a745;
      color: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }

    button i {
      margin-right: 5px;
    }
  </style>
</head>
<body>
    <nav class="navbar navbar-expand-sm">
    <div class="container-fluid">
      <div class="navbar-logo">Sistema</div>
      <ul class="navbar-links">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>  
      <div class="collapse navbar-collapse" id="collapsibleNavbar">
        <div class="droptdown">
        <a class="btn" href="index.html" role="button" aria-expanded="false">Inicio</a>
      </div>
      <div class="dropdown">
        <a class="btn dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Editar</a>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" id="dropdownEditarCliente"href="editar_cliente.html">Editar Clientes</a></li>
          <li><a class="dropdown-item" href="ver_cliente.html">Ver Clientes</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" id="dropdownEditarTrabajador" href="editar_trabajador.html">Editar Trabajador</a></li>
          <li><a class="dropdown-item" href="ver_trabajador.html">Ver Trabajadores</a></li>
        </ul>
      </div>
      <div class="dropdown">
        <a class="btn dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Agregar</a>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" id="dropdownRegistrarCliente" href="registro_cliente.html">Agregar Clientes</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" id="dropdownRegistrar" href="registro2.html">Agregar Trabajador</a></li>
        </ul>
      </div>
      <div class="dropdown">
        <a class="btn dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Dotación</a>
        <ul class="dropdown-menu">
          <a class="btn" href="dotacion_personal.html" role="button" aria-expanded="false">Agregar Dotación</a>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="ver_dotacion.html">Ver Dotación</a></li>
        </ul>
      </div>
      <div class="droptdown">
        <a class="btn" href="#" role="button" aria-expanded="false" onclick="logout()">Cerrar Sesión</a>
      </div>
      </div>
    </ul>
    </div>
  </nav>
  
  <div class="container">
    <h1><i class="fas fa-user-plus"></i> Editar Trabajador</h1>
    <form id="editarForm" method="post">
      <input type="text" id="nombre" name="nombre" placeholder="Nombre" required>
      <input type="text" id="apellido" name="apellido" placeholder="Apellido" required>
      <input type="text" id="rut" name="rut" placeholder="RUT" required>
      <select id="region_id" name="region_id" required>
        <option value="" disabled selected>Seleccione una región</option>
        <option value="1">Arica y Parinacota</option>
        <option value="2">Tarapacá</option>
        <option value="3">Antofagasta</option>
        <option value="4">Atacama</option>
        <option value="5">Coquimbo</option>
        <option value="6">Valparaíso</option>
        <option value="7">Región Metropolitana de Santiago</option>
        <option value="8">O’Higgins</option>
        <option value="9">Maule</option>
        <option value="10">Ñuble</option>
        <option value="11">Biobío</option>
        <option value="12">La Araucanía</option>
        <option value="13">Los Ríos</option>
        <option value="14">Los Lagos</option>
        <option value="15">Aysén del General Carlos Ibáñez del Campo</option>
        <option value="16">Magallanes y de la Antártica Chilena</option>
      </select>
      <input type="text" id="comuna" name="comuna" placeholder="Comuna" required>
      <input type="text" id="direccion" name="direccion" placeholder="Dirección" required>
      <input type="text" id="codigo_postal" name="codigo_postal" placeholder="Código Postal" required>
      <input type="text" id="telefono" name="telefono" placeholder="Teléfono" required>
      <input type="email" id="correo" name="correo" placeholder="Correo" required>
      <input type="password" id="contrasena" name="contrasena" placeholder="Contraseña" required disabled>
      <button type="button" id="recuperarContraseñaBtn">Recuperar Contraseña</button>
      <select id="rol_id" name="rol_id">
        <option value="" disabled selected>Seleccione un rol</option>
        <option value="1">Soporte TI</option>
        <option value="2">Gerente</option>
        <option value="3">Supervisor</option>
      </select>
      <button type="submit">Actualizar Trabajador</button>
    </form>
  </div>

  <script>
    function logout() {
      const confirmado = confirm("¿Estás seguro de que deseas cerrar sesión?");
      if (confirmado) {
        localStorage.removeItem("auth");
        localStorage.removeItem("usuario");
        localStorage.removeItem("correo");
        window.location.href = "login.html";
      }
    };

    document.getElementById('recuperarContraseñaBtn').addEventListener('click', function() {
      // Habilitar el campo de contraseña
      document.getElementById('contrasena').disabled = false;
      alert('Campo de contraseña habilitado. Por favor, ingrese una nueva contraseña.');
      // Limpiar el campo de contraseña
      document.getElementById('contrasena').value = '';
    });

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');

    async function cargarTrabajador(id) {
      try {
        const response = await fetch(`http://localhost:8090/get-trabajadores?id=${id}`);
        const data = await response.json();

        if (data.trabajadores && data.trabajadores.length > 0) {
          const trabajador = data.trabajadores.find(trabajador => trabajador.id === parseInt(id)); // Filtra el cliente por el ID

          document.getElementById('nombre').value = trabajador.nombre || '';
          document.getElementById('apellido').value = trabajador.apellido || '';
          document.getElementById('rut').value = trabajador.rut || '';

          const regionSelect = document.getElementById('region_id');
          regionSelect.value = trabajador.region_id || '';

          document.getElementById('comuna').value = trabajador.ciudad || '';
          document.getElementById('direccion').value = trabajador.direccion || '';
          document.getElementById('codigo_postal').value = trabajador.postal || '';
          document.getElementById('telefono').value = trabajador.telefono || '';
          document.getElementById('correo').value = trabajador.correo || '';
          document.getElementById('contrasena').value = trabajador.contrasena || '';

          const rolSelect = document.getElementById('rol_id');
          rolSelect.value = trabajador.rol_id|| '';
        } else {
          alert('Trabajador no encontrado');
        }
      } catch (error) {
        console.error('Error al obtener los datos del trabajador:', error);
        alert('Error al cargar los datos del trabajador.');
      }
    }

    cargarTrabajador(id);
    
    document.getElementById('editarForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const updatedTrabajador = {
        id,
        nombre: document.getElementById('nombre').value,
        apellido: document.getElementById('apellido').value,
        rut: document.getElementById('rut').value,
        telefono: document.getElementById('telefono').value,
        correo: document.getElementById('correo').value,
        direccion: document.getElementById('direccion').value,
        ciudad: document.getElementById('comuna').value,
        postal: document.getElementById('codigo_postal').value,
        region_id: document.getElementById('region_id').value,
        rol_id: document.getElementById('rol_id').value,
        contrasena: document.getElementById('contrasena').value
      };

      console.log('Datos enviados para actualizar el trabajador:', updatedTrabajador);  // Verifica que los datos sean correctos

      try {
        const response = await fetch(`http://localhost:8090/editarTrabajador/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatedTrabajador)
        });

        const result = await response.json();
        if (response.ok) {
          alert('Trabajador actualizado con éxito');
          // Redirigir al usuario de vuelta a la página de trabajadores
          window.location.href = 'editar_trabajador.html';
        } else {
          alert(result.message || 'Error al actualizar el trabajador');
        }
      } catch (error) {
        console.error('Error al actualizar el trabajador:', error);
        alert('Hubo un error al actualizar el trabajador.');
      }
    });

    function verificarAdmin(){
      const rol = localStorage.getItem("rol");
      console.log(rol);

      const dropdowns = {
        registrar: document.getElementById('dropdownRegistrar'),
        editarTrabajador: document.getElementById('dropdownEditarTrabajador'),
        editarCliente: document.getElementById('dropdownEditarCliente'),
        registrarCliente: document.getElementById('dropdownRegistrarCliente')
      };
      Object.values(dropdowns).forEach(dropdown => {
      dropdown.style.display = 'block';  // Mostrar los elementos
      });

      if (rol === 'Soporte TI' || rol === 'Gerente') {
            Object.values(dropdowns).forEach(dropdown => {
              dropdown.style.pointerEvents = 'auto'; // Hacer clickeables
              dropdown.style.color = ''; // Restaurar color
              dropdown.style.textDecoration = ''; // Restaurar subrayado
            });
        } else if (rol === 'Supervisor') {
            Object.values(dropdowns).forEach(dropdown => {
              dropdown.style.pointerEvents = 'none'; // Deshabilitar clickeo
              dropdown.style.color = 'gray'; // Cambiar color
              dropdown.style.textDecoration = 'none'; // Eliminar subrayado
            });
        }
    }

    window.onload = verificarAdmin;
  </script>
</body>
</html>

