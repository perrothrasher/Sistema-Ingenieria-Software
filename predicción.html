<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predicci√≥n de Dotaci√≥n de Personal - Sistema</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .top-bar {
            background-color: white;
            height: 60px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-size: 24px;
            font-weight: bold;
            color: #007bff !important;
            text-decoration: none;
        }
        
        .navbar {
            background-color: white;
            padding: 0.5rem 1rem;
        }
        
        .navbar-nav .nav-link {
            color: #6c757d;
            font-weight: 500;
        }
        
        .navbar-nav .nav-link:hover {
            color: #007bff;
        }
        
        .dropdown-menu {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            transition: transform 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .metric-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .metric-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .metric-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        .filter-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .prediction-area {
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 15px;
            padding: 30px;
        }
        .prediction-area.processing {
            border-color: #4f46e5;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }
        .progress-bar {
            transition: width 0.3s ease;
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        body {
            overflow-x: hidden;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
        }
        .prediction-chart {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Same navigation structure as historical data uploader -->
    <div class="top-bar d-flex align-items-center">
        <div class="container-fluid">
            <nav class="navbar navbar-expand-lg w-100">
                <a class="navbar-brand" href="#">Sistema</a>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">
                                <i class="fas fa-home"></i> Inicio
                            </a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-chart-line"></i> An√°lisis
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="visualizar_datos_historicos.html">
                                    <i class="fas fa-chart-bar"></i> Datos Hist√≥ricos</a></li>
                                <li><a class="dropdown-item" href="prediccion.html">
                                    <i class="fas fa-crystal-ball"></i> Predicciones</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showComingSoon()">
                                    <i class="fas fa-cogs"></i> Simulaciones</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-users"></i> Gesti√≥n
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="ver_cliente.html">Ver Clientes</a></li>
                                <li><a class="dropdown-item" href="ver_trabajador.html">Ver Trabajadores</a></li>
                                <li><a class="dropdown-item" href="dotacion_personal.html">Dotaci√≥n Personal</a></li>
                            </ul>
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle"></i> <span id="welcomeMessage">Usuario Demo</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </div>

    <!-- üîß Solo a√±adido id y clase (no se elimin√≥ nada m√°s) -->
    <div class="container-fluid mt-4 prediction-area" id="predictionArea">
        <!-- Header section adapted for prediction functionality -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h2 mb-1">
                            <i class="fas fa-crystal-ball text-primary"></i>
                            Predicci√≥n de Dotaci√≥n de Personal
                        </h1>
                        <p class="text-muted">Genera predicciones inteligentes basadas en datos hist√≥ricos y tendencias</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="refreshPredictions()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                        <button class="btn btn-primary" onclick="generatePrediction()">
                            <i class="fas fa-magic"></i> Nueva Predicci√≥n
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metrics cards adapted for prediction data -->
        <div class="row mb-4" id="metricsCards">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="metric-card p-4 h-100">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="text-white-50 small">Predicciones Generadas</div>
                            <div class="h4 mb-0 text-white font-weight-bold" id="totalPredictions">0</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x text-white-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="metric-card success p-4 h-100">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="text-white-50 small">Precisi√≥n Promedio</div>
                            <div class="h4 mb-0 text-white font-weight-bold" id="avgAccuracy">95.2%</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-bullseye fa-2x text-white-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="metric-card warning p-4 h-100">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="text-white-50 small">√öltima Predicci√≥n</div>
                            <div class="h6 mb-0 text-white font-weight-bold" id="lastPrediction">Sin predicciones</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x text-white-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="metric-card info p-4 h-100">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="text-white-50 small">Modelo IA</div>
                            <div class="h6 mb-0 text-white font-weight-bold">Activo</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-robot fa-2x text-white-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prediction parameters form -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-sliders-h text-primary"></i>
                        Par√°metros de Predicci√≥n
                    </h5>
                    
                    
                </div>
            </div>
        </div>

        <!-- Progress section for prediction processing -->
        <div id="progressSection" class="row mb-4 d-none">
            <div class="col-12">
                <div class="chart-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-bold text-dark">Procesando predicci√≥n con IA...</span>
                        <span id="progressText" class="text-primary fw-bold">0%</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="small text-muted mt-2" id="progressStatus">Analizando datos hist√≥ricos...</div>
                </div>
            </div>
        </div>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Results section for prediction output -->
        <div id="resultsSection" class="row mb-4 d-none">
            <div class="col-12">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-bar text-success"></i>
                        Resultados de la Predicci√≥n
                    </h5>
                    <div id="predictionResults"></div>
                </div>
            </div>
        </div>

        <!-- Prediction history -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-history text-info"></i>
                        Historial de Predicciones
                    </h5>
                    <div id="predictionHistory">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-crystal-ball fa-3x text-muted mb-3"></i>
                            <p class="fw-bold mb-1">No hay predicciones generadas a√∫n</p>
                            <p class="small text-muted">Las predicciones aparecer√°n aqu√≠ una vez que las generes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class StaffPredictionSystem {
            constructor() {
                this.progressSection = document.getElementById('progressSection');
                this.progressBar = document.getElementById('progressBar');
                this.progressText = document.getElementById('progressText');
                this.progressStatus = document.getElementById('progressStatus');
                this.alertContainer = document.getElementById('alertContainer');
                this.predictionHistory = document.getElementById('predictionHistory');
                this.resultsSection = document.getElementById('resultsSection');
                this.predictionResults = document.getElementById('predictionResults');
                this.predictions = JSON.parse(localStorage.getItem('staffPredictions') || '[]');
                
                this.renderPredictionHistory();
                this.updateMetrics();
            }
            async startPrediction() {
                if (!this.validateForm()) return;
                
                this.showProgress();
                const progressSteps = [
                    { progress: 20, status: 'Analizando datos hist√≥ricos...' },
                    { progress: 40, status: 'Aplicando algoritmos de machine learning...' },
                    { progress: 60, status: 'Calculando tendencias estacionales...' },
                    { progress: 80, status: 'Optimizando asignaci√≥n de recursos...' },
                    { progress: 100, status: 'Generando recomendaciones...' }
                ];

                try {
                    for (const step of progressSteps) {
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        this.updateProgress(step.progress, step.status);
                    }

                    await new Promise(resolve => setTimeout(resolve, 1000));

                    const predictionData = this.generatePredictionData();
                    this.predictions.unshift(predictionData);
                    localStorage.setItem('staffPredictions', JSON.stringify(this.predictions));

                    this.hideProgress();
                    this.showResults(predictionData);
                    this.showAlert('success', '¬°Predicci√≥n generada exitosamente! Revisa los resultados detallados.');
                    this.renderPredictionHistory();
                    this.updateMetrics();

                } catch (error) {
                    this.hideProgress();
                    this.showAlert('error', 'Error al generar la predicci√≥n. Por favor, verifica los par√°metros e intenta nuevamente.');
                }
            }

            validateForm() {
                const projectType = document.getElementById('projectType').value;
                const projectDuration = document.getElementById('projectDuration').value;
                const projectComplexity = document.getElementById('projectComplexity').value;

                if (!projectType || !projectDuration || !projectComplexity) {
                    this.showAlert('error', 'Por favor, completa todos los campos obligatorios.');
                    return false;
                }

                if (projectDuration < 1 || projectDuration > 365) {
                    this.showAlert('error', 'La duraci√≥n del proyecto debe estar entre 1 y 365 d√≠as.');
                    return false;
                }

                return true;
            }

            generatePredictionData() {
                const projectType = document.getElementById('projectType').value;
                const projectDuration = parseInt(document.getElementById('projectDuration').value);
                const projectComplexity = document.getElementById('projectComplexity').value;
                const seasonality = document.getElementById('seasonality').value;

                const baseStaff = {
                    'construccion': { base: 8, multiplier: 1.2 },
                    'mantenimiento': { base: 4, multiplier: 0.8 },
                    'instalacion': { base: 6, multiplier: 1.0 },
                    'reparacion': { base: 3, multiplier: 0.6 }
                };

                const complexityMultiplier = {
                    'baja': 0.8,
                    'media': 1.0,
                    'alta': 1.3,
                    'critica': 1.6
                };

                const durationFactor = Math.ceil(projectDuration / 7); // weeks
                const baseRequirement = baseStaff[projectType]?.base || 5;
                const totalStaff = Math.ceil(baseRequirement * complexityMultiplier[projectComplexity] * (durationFactor * 0.1 + 1));

                return {
                    id: Date.now(),
                    projectType: projectType,
                    duration: projectDuration,
                    complexity: projectComplexity,
                    seasonality: seasonality,
                    createdDate: new Date().toLocaleString('es-ES'),
                    totalStaff: totalStaff,
                    breakdown: {
                        supervisores: Math.ceil(totalStaff * 0.15),
                        tecnicos: Math.ceil(totalStaff * 0.6),
                        operarios: Math.ceil(totalStaff * 0.25)
                    },
                    confidence: Math.floor(Math.random() * 10) + 90, // 90-99%
                    estimatedCost: totalStaff * 2500 * Math.ceil(projectDuration / 30),
                    recommendations: this.generateRecommendations(projectType, projectComplexity)
                };
            }

            generateRecommendations(type, complexity) {
                const recommendations = {
                    'construccion': ['Considerar personal especializado en seguridad', 'Planificar rotaciones para trabajos pesados'],
                    'mantenimiento': ['Incluir t√©cnicos con certificaciones espec√≠ficas', 'Considerar horarios nocturnos'],
                    'instalacion': ['Personal con experiencia en el tipo de instalaci√≥n', 'Herramientas especializadas requeridas'],
                    'reparacion': ['Diagn√≥stico previo recomendado', 'Personal de emergencia disponible']
                };

                return recommendations[type] || ['Evaluaci√≥n detallada recomendada', 'Seguimiento continuo del proyecto'];
            }

            showResults(data) {
                const resultsHTML = `
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="result-card">
                                <h6 class="text-white-50">Personal Requerido</h6>
                                <h3 class="text-white">${data.totalStaff} personas</h3>
                                <small class="text-white-50">Confianza: ${data.confidence}%</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="result-card success">
                                <h6 class="text-white-50">Costo Estimado</h6>
                                <h3 class="text-white">$${data.estimatedCost.toLocaleString()}</h3>
                                <small class="text-white-50">Incluye beneficios</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="result-card warning">
                                <h6 class="text-white-50">Duraci√≥n</h6>
                                <h3 class="text-white">${data.duration} d√≠as</h3>
                                <small class="text-white-50">Proyecto ${data.complexity}</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="prediction-chart">
                        <h6 class="mb-3">Distribuci√≥n de Personal</h6>
                        <div class="row">
                            <div class="col-md-4 text-center">
                                <div class="h4 text-primary">${data.breakdown.supervisores}</div>
                                <small class="text-muted">Supervisores</small>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="h4 text-success">${data.breakdown.tecnicos}</div>
                                <small class="text-muted">T√©cnicos</small>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="h4 text-info">${data.breakdown.operarios}</div>
                                <small class="text-muted">Operarios</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6>Recomendaciones:</h6>
                        <ul class="list-unstyled">
                            ${data.recommendations.map(rec => `<li><i class="fas fa-check text-success me-2"></i>${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;

                this.predictionResults.innerHTML = resultsHTML;
                this.resultsSection.classList.remove('d-none');
                this.resultsSection.classList.add('fade-in');
            }

            showProgress() {
                this.progressSection.classList.remove('d-none');
                this.progressSection.classList.add('fade-in');
                document.getElementById('predictionArea').classList.add('processing');
            }

            hideProgress() {
                this.progressSection.classList.add('d-none');
                this.updateProgress(0, '');
                document.getElementById('predictionArea').classList.remove('processing');
            }

            updateProgress(progress, status) {
                this.progressBar.style.width = `${progress}%`;
                this.progressText.textContent = `${progress}%`;
                this.progressStatus.textContent = status;
            }

            showAlert(type, message) {
                const alertId = Date.now();
                const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
                const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';

                const alertHTML = `
                    <div id="alert-${alertId}" class="alert ${alertClass} alert-dismissible fade show mb-4" role="alert">
                        <i class="fas ${iconClass} me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;

                this.alertContainer.insertAdjacentHTML('beforeend', alertHTML);

                setTimeout(() => {
                    const alert = document.getElementById(`alert-${alertId}`);
                    if (alert) alert.remove();
                }, 5000);
            }

            renderPredictionHistory() {
                if (this.predictions.length === 0) {
                    this.predictionHistory.innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-crystal-ball fa-3x text-muted mb-3"></i>
                            <p class="fw-bold mb-1">No hay predicciones generadas a√∫n</p>
                            <p class="small text-muted">Las predicciones aparecer√°n aqu√≠ una vez que las generes</p>
                        </div>
                    `;
                    return;
                }

                const historyHTML = this.predictions.map(prediction => `
                    <div class="d-flex justify-content-between align-items-center p-3 mb-3 bg-light rounded border">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="bg-primary bg-opacity-10 rounded p-2">
                                    <i class="fas fa-crystal-ball text-primary"></i>
                                </div>
                            </div>
                            <div>
                                <p class="mb-1 fw-bold">${prediction.projectType.charAt(0).toUpperCase() + prediction.projectType.slice(1)} - ${prediction.complexity}</p>
                                <p class="small text-muted mb-0">${prediction.totalStaff} personas ‚Ä¢ ${prediction.duration} d√≠as ‚Ä¢ ${prediction.createdDate}</p>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-success me-2">${prediction.confidence}% confianza</span>
                            <button onclick="predictor.removePrediction(${prediction.id})" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

                this.predictionHistory.innerHTML = historyHTML;
            }

            removePrediction(predictionId) {
                this.predictions = this.predictions.filter(pred => pred.id !== predictionId);
                localStorage.setItem('staffPredictions', JSON.stringify(this.predictions));
                this.renderPredictionHistory();
                this.updateMetrics();
            }

            updateMetrics() {
                const totalPredictions = this.predictions.length;
                const lastPrediction = this.predictions.length > 0 
                    ? new Date(this.predictions[0].createdDate).toLocaleDateString('es-ES')
                    : 'Sin predicciones';

                document.getElementById('totalPredictions').textContent = totalPredictions;
                document.getElementById('lastPrediction').textContent = lastPrediction;
            }
        }
            async function entrenarModelo() {
                const r = await fetch('http://localhost:8090/prediccion/entrenar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ dataDir: '.' })   // carpeta donde est√°n tus Excel
                });
                const json = await r.json();
                predictor?.showAlert('success', 'Modelo entrenado: ' + (json?.result?.message || 'OK'));
                console.log('ENTRENAR >>', json);
                return json;
            }

        
            async function proyectarMes(anio, mes) {
            const r = await fetch(`http://localhost:8090/prediccion/proyectar?anio=${anio}&mes=${String(mes).padStart(2,'0')}`);
            const json = await r.json();
            console.log('PROYECTAR >>', json);

            const res = json?.result?.evaluacion_siguiente;
            if (res) {
            
            predictor.showResults({
                totalStaff: res.trabajadores_necesarios ?? 0,
                confidence: 95,                  
                estimatedCost: (res.trabajadores_necesarios ?? 0) * 2500,
                duration: 30,                     
                complexity: res.estado_modelo || res.estado_regla, 
                projectType: 'dotacion',
                breakdown: {
                supervisores: Math.ceil((res.trabajadores_necesarios ?? 0) * 0.15),
                tecnicos:     Math.ceil((res.trabajadores_necesarios ?? 0) * 0.60),
                operarios:    Math.ceil((res.trabajadores_necesarios ?? 0) * 0.25),
                },
                recommendations: [
                'Ajustar turnos seg√∫n carga',
                'Revisar licencias/vacaciones del per√≠odo'
                ],
                createdDate: new Date().toLocaleString('es-ES')
            });
            predictor.showAlert('success', `Proyecci√≥n ${res.estado_modelo || res.estado_regla} para ${res.mes}-${res.anio}`);
            } else {
            predictor.showAlert('error', 'No lleg√≥ un resultado v√°lido del backend.');
            }
            return json;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            predictor = new StaffPredictionSystem();
        });
        
        let predictor;
        document.addEventListener('DOMContentLoaded', () => { predictor = new StaffPredictionSystem(); });
    
        window.generatePrediction = async () => {
            console.log('[UI] Click en Nueva Predicci√≥n');
            await predictor.proyectarMes(2025, 8);  // cambia anio/mes si quieres
        };

        // (opcional) si tienes un bot√≥n para entrenar
        window.trainModel = () => predictor.entrenarModelo();
        

        function generatePrediction() {
            predictor.startPrediction();
        }

        function refreshPredictions() {
            predictor.renderPredictionHistory();
            predictor.updateMetrics();
            predictor.showAlert('success', 'Datos actualizados correctamente');
        }

        function showComingSoon() {
            predictor.showAlert('info', 'Esta funcionalidad estar√° disponible pr√≥ximamente');
        }

        function logout() {
            localStorage.removeItem("auth");
            localStorage.removeItem("rol");
            localStorage.removeItem("nombre");
            localStorage.removeItem("apellido");
            window.location.href = "login.html";
        }
    </script>

    <!-- ========= MODAL DETALLE DE PREDICCI√ìN (ADICI√ìN) ========= -->
        <div class="modal fade" id="predictionDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                <i class="fas fa-crystal-ball me-2 text-primary"></i>
                Detalle de la Predicci√≥n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                    <h6 class="text-muted mb-2">Resumen</h6>
                    <ul class="list-unstyled mb-0" id="modalSummary"></ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                    <h6 class="text-muted mb-2">Distribuci√≥n de Personal</h6>
                    <ul class="list-unstyled mb-0" id="modalBreakdown"></ul>
                    </div>
                </div>
                <div class="col-12">
                    <div class="border rounded p-3">
                    <h6 class="text-muted mb-2">Recomendaciones</h6>
                    <ul class="mb-0" id="modalRecs"></ul>
                    </div>
                </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <small class="text-muted" id="modalTimestamp"></small>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>
            </div>
            </div>
        </div>
        </div>
        <!-- ========= /MODAL ========= -->

        <!-- ========= SCRIPT DE EXTENSI√ìN (NO REEMPLAZA NADA) ========= -->
<script>
  class StaffPredictionSystem {
    constructor() {
      this.progressSection = document.getElementById('progressSection');
      this.progressBar = document.getElementById('progressBar');
      this.progressText = document.getElementById('progressText');
      this.progressStatus = document.getElementById('progressStatus');
      this.alertContainer = document.getElementById('alertContainer');
      this.predictionHistory = document.getElementById('predictionHistory');
      this.resultsSection = document.getElementById('resultsSection');
      this.predictionResults = document.getElementById('predictionResults');
      this.predictions = JSON.parse(localStorage.getItem('staffPredictions') || '[]');
      this.renderPredictionHistory?.();
      this.updateMetrics?.();
    }

    // ==== M√âTODOS UTILITARIOS YA EXISTENTES EN TU CLASE ====
    showAlert(type, message) {
      const el = document.createElement('div');
      el.className = `alert alert-${type} alert-dismissible fade show`;
      el.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
      this.alertContainer.innerHTML = '';
      this.alertContainer.appendChild(el);
      setTimeout(() => { try { bootstrap.Alert.getOrCreateInstance(el).close(); } catch(e){} }, 4000);
    }

    showResults(pred) {
      this.resultsSection.classList.remove('d-none');
      this.predictionResults.innerHTML = `
        <div class="result-card">
          <h5 class="mb-2">Estado proyectado</h5>
          <p class="mb-1"><strong>Trabajadores necesarios:</strong> ${pred.totalStaff}</p>
          <p class="mb-1"><strong>Estado:</strong> ${String(pred.complexity).toUpperCase()}</p>
          <p class="mb-0"><small>Generado: ${pred.createdDate}</small></p>
        </div>`;
      // historial m√≠nimo
      const hist = JSON.parse(localStorage.getItem('staffPredictions') || '[]');
      hist.push({ date: pred.createdDate, estado: pred.complexity, req: pred.totalStaff });
      localStorage.setItem('staffPredictions', JSON.stringify(hist));
    }

    // ======== IA: ENTRENAR Y PROYECTAR ========
    async entrenarModelo() {
      const r = await fetch('http://localhost:8090/prediccion/entrenar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dataDir: 'Servidor/ML/folios' }) // usa tu carpeta local de Excel
      });
      const json = await r.json();
      this.showAlert('success', 'Modelo entrenado: ' + (json?.result?.message || 'OK'));
      console.log('ENTRENAR >>', json);
      return json;
    }

    // Si no pasas anio/mes, el backend toma el √∫ltimo mes disponible
    async proyectarMes(anio = null, mes = null) {
      const qs = [];
      if (anio) qs.push(`anio=${anio}`);
      if (mes)  qs.push(`mes=${String(mes).padStart(2,'0')}`);
      const url = 'http://localhost:8090/prediccion/proyectar' + (qs.length ? `?${qs.join('&')}` : '');
      const r = await fetch(url);
      const json = await r.json();
      console.log('PROYECTAR >>', json);

      const res = json?.result?.evaluacion_siguiente;
      if (res) {
        this.showResults({
          totalStaff: res.trabajadores_necesarios ?? 0,
          confidence: 95,
          estimatedCost: (res.trabajadores_necesarios ?? 0) * 2500,
          duration: 30,
          complexity: res.estado_modelo || res.estado_regla, // 'sobre' | 'ok' | 'sub'
          projectType: 'dotacion',
          breakdown: { supervisores: 0, tecnicos: 0, operarios: 0 },
          recommendations: [],
          createdDate: new Date().toLocaleString('es-ES')
        });
        this.showAlert('success', `Proyecci√≥n ${res.estado_modelo || res.estado_regla} para ${res.mes}-${res.anio}`);
      } else {
        this.showAlert('danger', 'No lleg√≥ un resultado v√°lido del backend.');
      }
      return json;
    }
  }

  // Bot√≥n "Nueva Predicci√≥n"
  async function generatePrediction() {
    // Llama sin anio/mes para proyectar el siguiente mes disponible en ML/folios
    await predictor.proyectarMes();
  }

  // (Opcional) bot√≥n separado para entrenar
  async function trainModel() {
    await predictor.entrenarModelo();
  }
</script>


</body>
</html>
