<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editar Cliente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .form-container {
      max-width: 500px;
      margin: 20px auto;
      background-color: #f4f4f4;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      margin-top: 30px;
    }

    form input, form button {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      background-color: #28a745;
      color: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }

    button i {
      margin-right: 5px;
    }
  </style>
</head>
<body>
    <nav class="navbar navbar-expand-sm">
    <div class="container-fluid">
      <div class="navbar-logo">Sistema</div>
      <ul class="navbar-links">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>  
      <div class="collapse navbar-collapse" id="collapsibleNavbar">
        <div class="droptdown">
        <a class="btn" href="index.html" role="button" aria-expanded="false">Inicio</a>
      </div>
      <div class="dropdown">
        <a class="btn dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Editar</a>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" id="dropdownEditarCliente"href="editar_cliente.html">Editar Clientes</a></li>
          <li><a class="dropdown-item" href="ver_cliente.html">Ver Clientes</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" id="dropdownEditarTrabajador" href="editar_trabajador.html">Editar Trabajador</a></li>
          <li><a class="dropdown-item" href="ver_trabajador.html">Ver Trabajadores</a></li>
        </ul>
      </div>
      <div class="dropdown">
        <a class="btn dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Agregar</a>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" id="dropdownRegistrarCliente" href="registro_cliente.html">Agregar Clientes</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" id="dropdownRegistrar" href="registro2.html">Agregar Trabajador</a></li>
        </ul>
      </div>
      <div class="dropdown">
        <a class="btn dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Dotación</a>
        <ul class="dropdown-menu">
          <a class="btn" href="dotacion_personal.html" role="button" aria-expanded="false">Agregar Dotación</a>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="ver_dotacion.html">Ver Dotación</a></li>
        </ul>
      </div>
      <div class="droptdown">
        <a class="btn" href="#" role="button" aria-expanded="false" onclick="logout()">Cerrar Sesión</a>
      </div>
      </div>
    </ul>
    </div>
  </nav>

  <div class="container">
    <h1><i class="fas fa-edit"></i> Clientes Registrados</h1>
    <div class="row" >
        <table class="table" id="clientesTable">
          <thead class="table-success">
            <tr>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Correo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="clientesBody">
            <!-- Los datos de los clientes se cargarán aquí -->
          </tbody>
        </table>
    </div>  
  </div>
  
  <script>
    function logout() {
      const confirmado = confirm("¿Estás seguro de que deseas cerrar sesión?");
      if (confirmado) {
        localStorage.removeItem("auth");
        localStorage.removeItem("usuario");
        localStorage.removeItem("correo");
        window.location.href = "login.html";
      }
    };
    function verificarAdmin(){
      const rol = localStorage.getItem("rol");
      console.log(rol);

      const dropdowns = {
        registrar: document.getElementById('dropdownRegistrar'),
        editarTrabajador: document.getElementById('dropdownEditarTrabajador'),
        editarCliente: document.getElementById('dropdownEditarCliente'),
        registrarCliente: document.getElementById('dropdownRegistrarCliente')
      };
      Object.values(dropdowns).forEach(dropdown => {
      dropdown.style.display = 'block';  // Mostrar los elementos
      });

      if (rol === 'Soporte TI' || rol === 'Gerente') {
            Object.values(dropdowns).forEach(dropdown => {
              dropdown.style.pointerEvents = 'auto'; // Hacer clickeables
              dropdown.style.color = ''; // Restaurar color
              dropdown.style.textDecoration = ''; // Restaurar subrayado
            });
        } else if (rol === 'Supervisor') {
            Object.values(dropdowns).forEach(dropdown => {
              dropdown.style.pointerEvents = 'none'; // Deshabilitar clickeo
              dropdown.style.color = 'gray'; // Cambiar color
              dropdown.style.textDecoration = 'none'; // Eliminar subrayado
            });
        }
    }

    // Cargar los clientes desde el backend
    async function cargarClientes() {
      try {
        const response = await fetch('http://localhost:8090/get-clientes', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
      });
        const data = await response.json();
        
        if (response.ok) {
          const clientesBody = document.getElementById('clientesBody');
          clientesBody.innerHTML = ''; 

          // Iterar sobre los datos de los clientes y mostrarlos en la tabla
          data.clientes.forEach(cliente => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${cliente.nombre}</td>
              <td>${cliente.apellido}</td>
              <td>${cliente.correo}</td>
              <td class="btn-group">
                <button type="button" class="btn btn-light" onclick="eliminarCliente(${cliente.id})">Eliminar</button>
                <button type="button" class="btn btn-light" onclick="editarCliente(${cliente.id})">Editar</button>
              </td>
            `;
            clientesBody.appendChild(tr);
          });
        } else {
          alert('Error al cargar los clientes');
        }
      } catch (error) {
        console.error('Error fetching clients:', error);
        alert('Error al obtener los clientes');
      }
    }

    // Función para eliminar un cliente
    async function eliminarCliente(id) {
      if (confirm('¿Estás seguro de que deseas eliminar este cliente?')) {
        try {
          // Verificar si el ID es válido
          if (!id) {
            alert('ID de cliente no válido.', id);
            return;
          }
          console.log(`Eliminando cliente con ID: ${id}`);

          const response = await fetch(`http://localhost:8090/eliminarCliente/${id}`, {
            method: 'DELETE'
          });

          if (!response.ok) {
            throw new Error('Error al eliminar el cliente');
          }

          alert('Cliente eliminado con éxito');
          
          // Recargar los clientes después de la eliminación
          cargarClientes();
        } catch (error) {
          console.error('Error al eliminar el cliente:', error);
          alert('Hubo un error al eliminar el cliente.');
        }
      }
    }

    function editarCliente(id) {
      window.location.href = `editar.html?id=${id}`;
    }

    window.onload = function() {
      verificarAdmin();
      cargarClientes();
    };
    
    window.onload = () => {
      [verificarAdmin, cargarClientes].forEach(func => func());
    };
  </script>
</body>
</html>
